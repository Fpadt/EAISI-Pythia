---
title   : EAISI - Pythia
subtitle: Data Understanding
author  : "F.J. Padt"
date    : "`r format(Sys.time(), '%B %d, %Y')`"
output  :
  pdf_document:
    df_print: paged
    toc: yes
    toc_depth: 1      
editor_options:
  chunk_output_type: console
  markdown: 
    wrap: 80  
---

\newpage

![Logo](../images/logo.png)

# References

## SAC

## Teams

-   

# Setup

```{r}
#| label:  setup
#| eval:   true

# knitr::opts_chunk$set(
#   cache   = FALSE,
#   echo    = TRUE,     # include R source code in the output  
#   # eval    = TRUE,
#   message = FALSE,
#   warning = FALSE,
#   results = "markup",
#   image   = TRUE,  
#   include = TRUE      # include the chunk output in the output 
# )

SID <- "WPB500"
SYS <- substr(SID, 1, 3)

# SAP Access
library(reticulate)
use_condaenv("sapyr")

# public functions ---------------------------------------------------------
invisible(source('library/KnitR_SetUp.R'))

lsrc <- "notebooks/05_data_ingestion.R"  
if( file.exists(lsrc)){source(lsrc)}

# Configuration parameters of Open Hub DSCP_TRAN
FILE_SPEC <- 
  list(
    DELIM        = ';',
    HEADER       = FALSE,
    DATE_FOR     = '%Y-%m-%d'
  )

MAT <- MATN1("10023")

# setwd("C:/RW/EAISI-Pythia/notebooks")
lsrc <- "notebooks/30_modeling.R"  
if( file.exists(lsrc)){source(lsrc)}
```

# Data Import

## SC-113A (S4)

### SDMDMFR1

Forecast Accuracy (Month)

```{r}
#| label:   'get_data_SDMDMFR1'
#| comment: 'Forecast Accuracy (Month)'
#| eval:    false

# Active Data Table for DataStore SDMDMFR1 #### 
B4_SDMDMFR12_A <- 
   fRead_and_Union(
     pSIDCLNT  = "WPB500",
     pTable    = "/BIC/ASDMDMFR12",
     pOptions  = list(
       "MATERIAL = '000000000000010023'", "AND",
       "CALMONTH = '202409'"
     ),
     pFields   = list(
        # "COMP_CODE"       , # Company code                                     X
        # "SALESORG"        , # Sales Organization                               X
        # "MATERIAL"        , # Material                                         X
        # "CALMONTH"        , # Calendar year/month                              X
        # "RECORDMODE"      , #                                                  
        # "PLANT"           , # Plant                                            
        # "SALES_UNIT"      , # Sales unit                                       
        # "BASE_UOM"        , # Base Unit of Measure                             
        # "MAT_PLANT"       , # Material Plant                                   
        # "CURRENCY"        , # Currency key                                     
        # "CALQUARTER"      , # Calendar year/quarter                            
        # "CALYEAR"         , # Calendar year                                    
        # "CALMONTH2"       , # Calendar month                                   
        # "/BIC/UOM_SEL2"   , # UoM Selection: 1 = BUoM | 2 = SUoM               
        # "/BIC/FCPER"      , # Forecast Period                                  
        # "/BIC/MEAS_SEL2"  , # Measure selection                                
        # "MAT_SALES"       , # Material (Sales)                                 
        # "DISTR_CHAN"      , # Distribution Channel                             
        # "DLV_QTY"         , # Actual quantity delivered (in sales units)       
        # "ACT_DL_QTY"      , # Actual quantity delivered in stockkeeping units  
        # "REQU_QTY"        , # Desired Delivery Quantity                        
        # "/BIC/FC8QTYB"    , # Forecast qty -8 BU                               
        # "/BIC/FC8_QTY"    , # Forecast qty -8 (SUoM)                           
        # "/BIC/FC13SUQTY"  , # Forecast Qty -13 SU                              
        # "/BIC/FC13_QTY"   , # Forecast qty -13 (BUoM)                          
        # "/BIC/FER8QTYB"   , # Forecast Error -8 BU                             
        # "/BIC/FERR8QTY"   , # Forecast Error -8 (SUoM)                         
        # "/BIC/FERR13QTY"  , # Forcast Error -13  (BUoM)                        
        # "/BIC/FER13QTYS"  , # Forecast Error -13 SU                            
        # "/BIC/ACTVAL"     , # Actuals amount                                   
        # "/BIC/FC8VAL"     , # Forecast -8 amount                               
        # "/BIC/FCER8VAL"   , # Forecast err -8 amount                           
        # "/BIC/FC13VAL"    , # Forecast -13 amount                              
        # "/BIC/FCER13VAL"  , # Forecast err -13 amount                          
        # "/BIC/F4QTYB"     , # Forecast Qty -4  (BUoM)                          
        # "/BIC/F4QTYS"     , # Forecast Qty -4  (SUoM)                          
        # "/BIC/F4VAL"      , # Forecast -4 amount                               
        # "/BIC/FER4QTYB"   , # Forecast Error -4  (BUoM)                        
        # "/BIC/FER4QTYS"   , # Forecast Error -4  (SUoM)                        
        # "/BIC/FER4VAL"    , # Forecast Error -4 amount                         
        # "/BIC/FCQTYBU"    , # Forecast Qty BU                                  
        # "/BIC/FCQTYSU"    , # Forecast Qty SU                                  
        # "/BIC/FERQTYB"    , # Forecast Error  (BUoM)                           
        # "/BIC/FERQTYS"    , # Forecast Error (SUoM)                            
        # "/BIC/FCVAL"      , # Forecast amount                                  
        # "/BIC/FERVAL"       # Forecast Error amount                            
    ),
     pRowcount = Inf
   )

```

### SDMDMFR2

Forecast Accuracy BOM (Month)

```{r}
#| label:  'get_data_SDMDMFR2'
#| comment: 'Forecast Accuracy BOM (Month)'
#| eval:    false

# Active Data Table for DataStore SDMDMFR2 #### 
B4_SDMDMFR22_A <- 
   fRead_and_Union(
     pSIDCLNT  = "WPB500",
     pTable    = "/BIC/ASDMDMFR22",
     pOptions  = list(),
     pFields   = list(
        # "COMP_CODE"       , # Company code                                     X
        # "SALESORG"        , # Sales Organization                               X
        # "MATERIAL"        , # Material                                         X
        # "CALMONTH"        , # Calendar year/month                              X
        # "/BIC/MAT_PROMO"  , # Promotional Material                             X
        # "RECORDMODE"      , #                                                  
        # "PLANT"           , # Plant                                            
        # "SALES_UNIT"      , # Sales unit                                       
        # "BASE_UOM"        , # Base Unit of Measure                             
        # "MAT_PLANT"       , # Material Plant                                   
        # "CURRENCY"        , # Currency key                                     
        # "CALQUARTER"      , # Calendar year/quarter                            
        # "CALYEAR"         , # Calendar year                                    
        # "CALMONTH2"       , # Calendar month                                   
        # "/BIC/PROMO_IDC"  , # Promotion Indicator                              
        # "/BIC/UOM_SEL2"   , # UoM Selection: 1 = BUoM | 2 = SUoM               
        # "/BIC/FCPER"      , # Forecast Period                                  
        # "/BIC/MEAS_SEL2"  , # Measure selection                                
        # "MAT_SALES"       , # Material (Sales)                                 
        # "DISTR_CHAN"      , # Distribution Channel                             
        # "/BIC/PRDH1"      , # Name of the Brand                                
        # "/BIC/PRDH2"      , # Main Category                                    
        # "/BIC/PRDH3"      , # Product Sub Category                             
        # "/BIC/PRDH4"      , # Product Family                                   
        # "DLV_QTY"         , # Actual quantity delivered (in sales units)       
        # "ACT_DL_QTY"      , # Actual quantity delivered in stockkeeping units  
        # "REQU_QTY"        , # Desired Delivery Quantity                        
        # "/BIC/FC8QTYB"    , # Forecast qty -8 BU                               
        # "/BIC/FC8_QTY"    , # Forecast qty -8 (SUoM)                           
        # "/BIC/FC13SUQTY"  , # Forecast Qty -13 SU                              
        # "/BIC/FC13_QTY"   , # Forecast qty -13 (BUoM)                          
        # "/BIC/FER8QTYB"   , # Forecast Error -8 BU                             
        # "/BIC/FERR8QTY"   , # Forecast Error -8 (SUoM)                         
        # "/BIC/FERR13QTY"  , # Forcast Error -13  (BUoM)                        
        # "/BIC/FER13QTYS"  , # Forecast Error -13 SU                            
        # "/BIC/ACTVAL"     , # Actuals amount                                   
        # "/BIC/FC8VAL"     , # Forecast -8 amount                               
        # "/BIC/FCER8VAL"   , # Forecast err -8 amount                           
        # "/BIC/FC13VAL"    , # Forecast -13 amount                              
        # "/BIC/FCER13VAL"  , # Forecast err -13 amount                          
        # "/BIC/F4QTYB"     , # Forecast Qty -4  (BUoM)                          
        # "/BIC/F4QTYS"     , # Forecast Qty -4  (SUoM)                          
        # "/BIC/F4VAL"      , # Forecast -4 amount                               
        # "/BIC/FER4QTYB"   , # Forecast Error -4  (BUoM)                        
        # "/BIC/FER4QTYS"   , # Forecast Error -4  (SUoM)                        
        # "/BIC/FER4VAL"    , # Forecast Error -4 amount                         
        # "/BIC/FCQTYBU"    , # Forecast Qty BU                                  
        # "/BIC/FCQTYSU"    , # Forecast Qty SU                                  
        # "/BIC/FERQTYB"    , # Forecast Error  (BUoM)                           
        # "/BIC/FERQTYS"    , # Forecast Error (SUoM)                            
        # "/BIC/FCVAL"      , # Forecast amount                                  
        # "/BIC/FERVAL"       # Forecast Error amount                            
    ),
     pRowcount = Inf
   )

```

### SDWDMMG1

Demand and Forecast (Month)

```{r}
#| label: 'get_data_SDWDMMG1'
#| eval:  false

# Active Data Table for DataStore SDWDMMG1 #### 
B4_SDWDMMG12_A <- 
   fRead_and_Union(
     pSIDCLNT  = "WPB500",
     pTable    = "/BIC/ASDWDMMG12",
     pOptions  = list(
       "MATERIAL = '000000000000010023'", "AND",
       "CALMONTH = '202409'"
     ),
     pFields   = list(
        # "COMP_CODE"       , # Company code                                     X
        # "SALESORG"        , # Sales Organization                               X
        # "MATERIAL"        , # Material                                         X
        # "CALMONTH"        , # Calendar year/month                              X
        # "SALES_UNIT"      , # Sales unit                                       X
        # "BASE_UOM"        , # Base Unit of Measure                             X
        # "RECORDMODE"      , #                                                  
        # "DISTR_CHAN"      , # Distribution Channel                             
        # "PLANT"           , # Plant                                            
        # "/BIC/PRDH1"      , # Name of the Brand                                
        # "/BIC/PRDH2"      , # Main Category                                    
        # "/BIC/PRDH3"      , # Product Sub Category                             
        # "/BIC/PRDH4"      , # Product Family                                   
        # "/BIC/MAT_PROMO"  , # Promotional Material                             
        # "/BIC/PROMO_IDC"  , # Promotion Indicator                              
        # "DLV_QTY"         , # Actual quantity delivered (in sales units)       
        # "ACT_DL_QTY"      , # Actual quantity delivered in stockkeeping units  
        # "REQU_QTY"        , # Desired Delivery Quantity                        
        # "/BIC/FCQTYBU"    , # Forecast Qty BU                                  
        # "/BIC/FCQTYSU"    , # Forecast Qty SU                                  
        # "/BIC/F4QTYB"     , # Forecast Qty -4  (BUoM)                          
        # "/BIC/F4QTYS"     , # Forecast Qty -4  (SUoM)                          
        # "/BIC/FC8QTYB"    , # Forecast qty -8 BU                               
        # "/BIC/FC8_QTY"    , # Forecast qty -8 (SUoM)                           
        # "/BIC/FC13SUQTY"  , # Forecast Qty -13 SU                              
        # "/BIC/FC13_QTY"     # Forecast qty -13 (BUoM)                          
    ),
     pRowcount = Inf
   )

```

### SDSFRCT0

Sales forecast history weekly

```{r}
#| label: 'get_data_SDSFRCT0'
#| eval:  false

# Active Data Table for DataStore SDSFRCT0 #### 
B4_SDSFRCT02_A <- 
   fRead_and_Union(
     pSIDCLNT  = "WPB500",
     pTable    = "/BIC/ASDSFRCT02",
     pOptions  = list(
       paste0("MATERIAL = '", MAT, "'")
     ),
     pFields   = list(
        "PLANT"          , # Plant                          X
        "MATERIAL"       , # Material                       X
        "CALDAY"         , # Calendar day                   X
        "/BIC/VERSDATE"  , # Version date                   X
        # "RECORDMODE"     , # NA
        "CALWEEK"        , # Calendar year / week
        "/BIC/VERSWEEK"  , # Version week
        # "MAT_PLANT"      , # Material Plant
        "/BIC/KOPRW"     , # Corrected value forecast
        # "/BIC/PRWRT"     , # Forecast value (Qty)
        "BASE_UOM"       , # Base Unit of Measure
        "/BIC/PERKZ"       # Period Indicator
    ),
     pRowcount = Inf
   ) 

```

### SDSFRCT1

Sales forecast history daily

```{r}
#| label: 'get_data_SDSFRCT1'
#| eval:  false

SDSFRCT02 <- 
  copy(B4_SDSFRCT02_A)                         %>%
  .[CALWEEK %between% c('202401', '202452')]   %>%
  .[VERSDATE >= ymd("2023/09/04")]

```

## SC-113B (DYN)

### SDWVAIT0

Sales order item (& SSL)

```{r}
#| label: 'get_data_SDWVAIT0'
#| eval:  true

# Active Data Table for DataStore SDWVAIT0 #### 
B4_SDWVAIT02_A <- 
   fRead_and_Union(
     pSIDCLNT  = "WPB500",
     pTable    = "/BIC/ASDWVAIT02",
     pOptions  = list(
       "MATERIAL   EQ '000000000000010023'", "AND",
       "ACT_DL_DTE GE '20240901'"          , "AND",
       "ACT_DL_DTE LE '20240930'"
     ),
     pFields   = list(
        # "FISCVARNT"       , # Fiscal year variant                                           X
        # "DOC_NUMBER"      , # Sales document                                                X
        # "S_ORD_ITEM"      , # Sales document item                                           X
        # "RECORDMODE"      , #                                                               
        # "REJECTN_ST"      , # Rejection status for SD item                                  
        # "STS_ITM"         , # General incompletion status of the item                       
        # "STS_BILL"        , # Item incompletion status with respect to billing              
        # "STS_PRC"         , # Item is incomplete with respect to pricing                    
        # "STS_DEL"         , # Incompletion status of the item with regard to delivery       
        # "QUOT_FROM"       , # Quotation validity date (quotation is valid from ...)         
        # "DOC_TYPE"        , # Sales document type                                           
        # "ORD_REASON"      , # Order reason (reason for the business transaction)            
        # "QUOT_TO"         , # Date until which bid/quotation is binding (valid-to date)     
        # "COMP_CODE"       , # Company code                                                  
        # "BILL_BLOCK"      , # Billing block in SD document                                  
        # "SOLD_TO"         , # Sold-to party                                                 
        # "RATE_TYPE"       , # Exchange Rate Type                                            
        # "CUST_GRP1"       , # Forecast group                                                
        # "CUST_GRP2"       , # Control Prc Inv                                               
        # "CUST_GRP3"       , # Shelf life Grp                                                
        # "CUST_GRP4"       , # Deliv. GSL grp                                                
        # "CUST_GRP5"       , # Customer group 5                                              
        # "DEL_BLOCK"       , # Delivery block document header                                
        # "DOC_CATEG"       , # Sales Document Category                                       
        # "SALES_OFF"       , # Sales Office                                                  
        # "SALES_GRP"       , # Sales group                                                   
        # "SALESORG"        , # Sales Organization                                            
        # "DISTR_CHAN"      , # Distribution Channel                                          
        # "REASON_REJ"      , # Reason for rejection of quotations and sales orders           
        # "CH_ON"           , # Last changed on                                               
        # "ORDER_PROB"      , # Order probability of the item                                 
        # "BWAPPLNM"        , # Application component                                         
        # "PROCESSKEY"      , # BW: Transaction Key                                           
        # "BATCH"           , # Batch number                                                  
        # "EANUPC"          , # European Article Numbers/Universal Product Code               
        # "CREATEDON"       , # Date on which the record was created                          
        # "CREATEDBY"       , # Name of person who created the object                         
        # "CREA_TIME"       , # Time Created                                                  
        # "BILBLK_ITM"      , # Billing block for item                                        
        # "SALESDEAL"       , # Sales Deal                                                    
        # "STOR_LOC"        , # Storage location                                              
        # "MATL_GROUP"      , # Material group                                                
        # "MAT_ENTRD"       , # Material Entered                                              
        # "MATL_GRP_1"      , # Material group 1                                              
        # "MATL_GRP_2"      , # Material group 2                                              
        # "MATL_GRP_3"      , # Material group 3                                              
        # "MATL_GRP_4"      , # Material group 4                                              
        # "MATL_GRP_5"      , # Material group 5                                              
        # "UNLD_PT_WE"      , # Unloading point of the ship-to party                          
        # "BILLTOPRTY"      , # Bill-to party                                                 
        # "PAYER"           , # Payer                                                         
        # "/BIC/ZFDEST"     , # Final Destination                                             
        # "HG_LV_ITEM"      , # Higher-level item in bill of material structures              
        # "SHIP_TO"         , # Ship-To Party                                                 
        # "PROD_HIER"       , # Product hierarchy                                             
        # "FORWAGENT"       , # Forw.Agent                                                    
        # "ITEM_CATEG"      , # Sales document item category                                  
        # "SALESEMPLY"      , # Sales Representative                                          
        # "ROUTE"           , # Route                                                         
        # "SHIP_STCK"       , # Delivery from Warehouse                                       
        # "DIVISION"        , # Division                                                      
        # "STAT_DATE"       , # Statistics date                                               
        # "BND_IND"         , # Independent of Delivery Tolerances                            
        # "ST_UP_DTE"       , # Update Date Statistics                                        
        # "PRVDOC_CTG"      , # Preceding document category                                   
        # "SHIP_POINT"      , # Shipping point                                                
        # "PLANT"           , # Plant                                                         
        # "SALES_DIST"      , # Sales District                                                
        # "SERV_DATE"       , # Date on which services rendered                               
        # "BILL_DATE"       , # Date for invoice/billing index and printout                   
        # "INCOTERMS"       , # Incoterms part 1                                              
        # "INCOTERMS2"      , # Incoterms part 2                                              
        # "CUST_GROUP"      , # Customer group                                                
        # "ACCNT_ASGN"      , # Customer Account Assignment Group                             
        # "TRANS_DATE"      , # Conversion Date                                               
        # "PRICE_DATE"      , # Date for pricing and exchange rate                            
        # "RT_PROMO"        , # Promotion                                                     
        # "PRODCAT"         , # Product catalog number                                        
        # "DIV_HEAD"        , # Division for order header                                     
        # "DOC_CATEGR"      , # SD document category of the reference document                
        # "WBS_ELEMT"       , # Work Breakdown Structure Element (WBS Element)                
        # "COND_PR_UN"      , # Price Unit                                                    
        # "SUB_REASON"      , # Material - Reason for Substitution                            
        # "MATERIAL"        , # Material                                                      
        # "MAT_SALES"       , # Material (Sales)                                              
        # "MAT_PLANT"       , # Material Plant                                                
        # "REFER_DOC"       , # Document number of the reference document                     
        # "REFER_ITM"       , # Item number of the reference item                             
        # "APOPLANNED"      , # Sales Scheduling Agreement Item Planned in SAP APO            
        # "/BIC/ANTLF"      , # Max. Part. Del                                                
        # "/BIC/KZTLF"      , # Partial delivery indicator                                    
        # "PROMOTION"       , # Promotion                                                     
        # "PROFIT_CTR"      , # Profit Center                                                 
        # "CO_AREA"         , # Controlling area                                              
        # "DLV_STSO"        , # Overall delivery status of the item                           
        # "DLV_STS"         , # Delivery Status                                               
        # "GI_STS"          , # Goods Issue Status                                            
        # "LW_GISTS"        , # Lowest GI Status of an Order Item                             
        # "DSDEL_DATE"      , # Requested delivery date (MRP)                                 
        # "DSDEL_TIME"      , # Requested Delivery Time                                       
        # "CONF_DATE"       , # Confirmed Delivery Date                                       
        # "CONF_TIME"       , # Confirmed Delivery Time                                       
        # "PLD_GI_DTE"      , # Planned Goods Issue Date of a Confirmed Scheule Line          
        # "ACT_GI_DTE"      , # Actual goods issue date                                       
        # "LST_A_GD"        , # Last Actual Goods Issue Date of an Order Item                 
        # "ACT_DL_DTE"      , # Actual Delivery Date                                          
        # "ACT_DL_TME"      , # Actual Delivery Time                                          
        # "LST_A_DD"        , # Last Actual Delivery Date of an Order Item                    
        # "LST_A_DT"        , # Last Actual Delivery Time of an Order Item                    
        # "DLV_BLOCKD"      , # Default delivery block                                        
        # "SCHED_DEL"       , # Schedule Line Deleted                                         
        # "REC_DELETD"      , # Record deleted                                                
        # "LOGSYS"          , # Source System                                                 
        # "UNIT_OF_WT"      , # Weight unit                                                   
        # "SALES_UNIT"      , # Sales unit                                                    
        # "BASE_UOM"        , # Base Unit of Measure                                          
        # "DOC_CURRCY"      , # Document currency                                             
        # "VOLUMEUNIT"      , # Volume unit                                                   
        # "TARGET_QU"       , # Target quantity UoM                                           
        # "LOC_CURRCY"      , # Local currency                                                
        # "SHIP_COND"       , # Shipping conditions                                           
        # "/BIC/PO_TYPE"    , # PO type                                                       
        # "/BIC/ZVEBLV"     , # Original order number                                         
        # "/BIC/ERNAMO"     , # Creator original sales order                                  
        # "/BIC/COMPL_INV"  , # "Invoiced" Indicator                                          
        # "CURRENCY"        , # Currency key                                                  
        # "/BIC/SCALE_IND"  , # Scale Usage Indication                                        
        # "/BIC/SCALE_LVL"  , # Scale Qty Level                                               
        # "CUSTOMER"        , # Customer number                                               
        # "CUST_SALES"      , # Customer number (sales view)                                  
        # "GROSS_WGT"       , # Gross Weight of Sales Item                                    
        # "EXCHG_CRD"       , # Credit data exchange rate for requested delivery date         
        # "CML_CF_QTY"      , # Cumulative confirmed quantity in sales unit                   
        # "CML_CD_QTY"      , # Cumulative confirmed quantity in base unit                    
        # "CML_OR_QTY"      , # Cumulative order quantity in sales units                      
        # "SUBTOTAL_1"      , # Condition Subtotal 1 from Pricing Procedure                   
        # "SUBTOTAL_2"      , # Condition Subtotal 2 from Pricing Procedure                   
        # "SUBTOTAL_3"      , # Invoiced sales (DC)                                           
        # "SUBTOTAL_4"      , # Condition Subtotal 4 from Pricing Procedure                   
        # "SUBTOTAL_5"      , # Condition Subtotal 5 from Pricing Procedure                   
        # "SUBTOTAL_6"      , # Condition Subtotal 6 from Pricing Procedure                   
        # "MIN_DL_QTY"      , # Minimum delivery quantity in delivery note processing         
        # "REQDEL_QTY"      , # Cumulative required delivery qty (all dlv-relev.sched.lines)  
        # "NET_PRICE"       , # Net price                                                     
        # "NET_VALUE"       , # Net value of the order item in document currency              
        # "NET_WT_AP"       , # Net weight of item                                            
        # "EXCHG_STAT"      , # Exchange rate for statistics                                  
        # "UPPR_BND"        , # Tolerance Limit for Over Delivery in %                        
        # "DENOMINTR"       , # Denominator (divisor) for conversion of sales qty. into SKU   
        # "NUMERATOR"       , # Numerator(Factor) for Conversion of Sales Quantity Into SKU   
        # "DENOMINTRZ"      , # Factor for converting sales units to base units (target qty)  
        # "NUMERATORZ"      , # Numerator for Converting Sales from Targt Qty to Qty Stored   
        # "LOWR_BND"        , # Tolerance Limit for Under Delivery in %                       
        # "VOLUME_AP"       , # Volume of Order Item                                          
        # "COST"            , # Cost in document currency                                     
        # "TARGET_QTY"      , # Target quantity in sales units                                
        # "TARG_VALUE"      , # Target value with outline agreement in document currency      
        # "EXCHG_RATE"      , # Exchange rate for pricing and statistics                      
        # "ORD_ITEMS"       , # Sales Order Item                                              
        # "TAX_VALUE"       , # Tax Amount in SD Document Currency                            
        # "NETPR_VKM"       , # Net Price per 1*VKME                                          
        # "REQU_QTY"        , # Desired Delivery Quantity                                     
        # "CONF_QTY"        , # Confirmed quantity                                            
        # "DLV_QTY"         , # Actual quantity delivered (in sales units)                    
        # "/BIC/OPSALQTY"   , # Missed sales qty (SU)                                         
        # "/BIC/DLV_QTYBU"  , # Actual quantity delivered BUOM (Req. Del.Date)                
        # "PRICE_MAT"       , # Material Price                                                
        # "/BIC/SC_VAL_BU"    # Scale Value per BU                                            
    ),
     pRowcount = Inf
   )

```

### SDMFRCAC ❔

Dynasys forecast accuracy

```{r}
#| label: 'get_data_SDMFRCAC'
#| eval:  true

# Active Data Table for DataStore SDMFRCAC #### 
B4_SDMFRCAC2_A <- 
   fRead_and_Union(
     pSIDCLNT  = "WPB500",
     pTable    = "/BIC/ASDMFRCAC2",
     pOptions  = list(
       "SALESORG = 'FR30'"             , "AND",
       paste0("MATERIAL = '", MAT, "'"), "AND",
       "/BIC/VERSMON >= '202301'"      , "AND",
       "CALMONTH LE '202501'"
     ),
     pFields   = list(
        "COMP_CODE"       , # Company code                  X
        "SALESORG"        , # Sales Organization            X
        "PLANT"           , # Plant                         X
        "MATERIAL"        , # Material                      X
        "CUST_HIE03"      , # Customer Hierarchy Level 3    X
        "CALMONTH"        , # Calendar year/month           X
        "/BIC/VERSMON"    , # Version Calendar year/month   X
        "/BIC/VTYPE"      , # Value Type for Reporting      X
        "/BIC/FTYPE"      , # Forecast Type                 X
        # "RECORDMODE"      , #
        # "/BIC/MNTHDIFF"   , # Months Difference
        # "CUST_SALES"      , # Customer number (sales view)
        # "MAT_PLANT"       , # Material Plant
        # "MAT_SALES"       , # Material (Sales)
        # "DISTR_CHAN"      , # Distribution Channel
        "CUSTOMER"        , # Customer number
        # "DIVISION"        , # Division
        # "CALYEAR"         , # Calendar year
        # "CALMONTH2"       , # Calendar month
        "CUST_HIE02"      , # Customer Hierarchy Level 2
        "CUST_HIE01"      , # Customer Hierarchy Level 1
        "BASE_UOM"        , # Base Unit of Measure
        "/BIC/DEMND_QTY"  , # Demand qty
        "/BIC/BSELN_QTY"  , # Baseline qty
        # "/BIC/PROMO_QTY"  , # Promotion qty
        # "/BIC/DMDCP_QTY"  , # Demand components qty
        # "/BIC/PRMCP_QTY"  , # Promo components qty
        "/BIC/DEMQTYM0"   , # Demand qty ALL
        "/BIC/DEMQTYM1"   , # Demand qty M-1
        "/BIC/DEMQTYM2"   , # Demand qty M-2
        "/BIC/DEMQTYM3"   , # Demand qty M-3
        "/BIC/BSLNQTYM0"  , # Baseline qty ALL
        "/BIC/BSLNQTYM1"  , # Baseline qty M-1
        "/BIC/BSLNQTYM2"  , # Baseline qty M-2
        "/BIC/BSLNQTYM3"  , # Baseline qty M-3
        "/BIC/PRMQTYM0"   , # Promotion qty ALL
        "/BIC/PRMQTYM1"   , # Promotion qty M-1
        "/BIC/PRMQTYM2"   , # Promotion qty M-2
        "/BIC/PRMQTYM3"   #, # Promotion qty M-3
        # "/BIC/DMCPQTYM0"  , # Demand components qty ALL
        # "/BIC/DMCPQTYM1"  , # Demand components qty M-1
        # "/BIC/DMCPQTYM2"  , # Demand components qty M-2
        # "/BIC/DMCPQTYM3"  , # Demand components qty M-3
        # "/BIC/PRCPQTYM0"  , # Promo components qty ALL
        # "/BIC/PRCPQTYM1"  , # Promo components qty M-1
        # "/BIC/PRCPQTYM2"  , # Promo components qty M-2
        # "/BIC/PRCPQTYM3"    # Promo components qty M-3
    ),
     pRowcount = Inf
   ) 

if(rstudioapi::showQuestion(
  title   = "Save?", 
  message = "Do you want to save the data?"
) == TRUE) {
  saveRDS(
    object = B4_SDMFRCAC2_A, 
    file = file.path(PDAT, "B4_SDMFRCAC2_A.rds")
  )
}
```

### SDSFRPR1 ✔

Dynasys pre demand review actuals

```{r}
#| label:   'get_data_SDSFRPR1'
#| comment: 'pre-DR Forecast ####'
#| eval:    true

# Active Data Table for DataStore SDSFRPR1 #### 
B4_SDSFRPR12_A <- 
   fRead_and_Union(
     pSIDCLNT  = "WPB500",
     pTable    = "/BIC/ASDSFRPR12",
     pOptions  = list(
       paste0("MATERIAL = '", MAT, "'"), "AND",
       "/BIC/VERSMON >= '202301'"
     ),
     pFields   = list(
        "COMP_CODE"       , # Company code                 X
        "SALESORG"        , # Sales Organization           X
        "PLANT"           , # Plant                        X
        "MATERIAL"        , # Material                     X
        "CUST_HIE03"      , # Customer Hierarchy Level 3   X
        "CALMONTH"        , # Calendar year/month          X
        "VTYPE"           , # Value Type for Reporting     X
        # "/BIC/FTYPE"      , # Forecast Type                X
        "/BIC/VERSMON"    , # Version Calendar year/month  X
        # "RECORDMODE"      , #
        # "UPD_DATE"        , # Update Date
        "CUST_HIE02"      , # Customer Hierarchy Level 2
        "CUST_HIE01"      , # Customer Hierarchy Level 1
        "/BIC/DEMND_QTY"  , # Demand qty
        # "/BIC/BSELN_QTY"  , # Baseline qty
        # "/BIC/PROMO_QTY"  , # Promotion qty
        # "/BIC/DMDCP_QTY"  , # Demand components qty
        # "/BIC/PRMCP_QTY"  , # Promo components qty
        "BASE_UOM"          # Base Unit of Measure
    ),
     pRowcount = Inf
   )

if(rstudioapi::showQuestion(
  title   = "Save?", 
  message = "Do you want to save the data?"
) == TRUE) {
  saveRDS(
    object = B4_SDSFRPR12_A, 
    file = file.path(PDAT, "B4_SDSFRPR12_A.rds")
  )
}
```

### SDMFRPR1 ❌

Dynasys pre demand review actuals

Only actuals where the difference between VERSMON and CALMONTH is 1 

Enriched with

- Company Code
- CalYear
- CalMonth


```{r}
#| label:   'get_data_SDMFRPR1' 
#| comment: 'pre-DR Actuals ####'
#| eval:    false

# Active Data Table for DataStore SDMFRPR1 #### 
B4_SDMFRPR12_A <- 
   fRead_and_Union(
     pSIDCLNT  = "WPB500",
     pTable    = "/BIC/ASDMFRPR12",
     pOptions  = list(
       paste0("MATERIAL = '", MAT, "'"), "AND",
       "/BIC/VERSMON >= '202306'"
     ),
     pFields   = list(
        "COMP_CODE"       , # Company code                  X
        "SALESORG"        , # Sales Organization            X
        "PLANT"           , # Plant                         X
        "MATERIAL"        , # Material                      X
        "CUST_HIE03"      , # Customer Hierarchy Level 3    X
        "CALMONTH"        , # Calendar year/month           X
        "/BIC/VERSMON"    , # Version Calendar year/month   X
        "VTYPE"           , # Value Type for Reporting      X
        # "/BIC/FTYPE"      , # Forecast Type                 X
        # "RECORDMODE"      , #
        "UPD_DATE"        , # Update Date
        # "CUST_SALES"      , # Customer number (sales view)
        # "MAT_PLANT"       , # Material Plant
        # "MAT_SALES"       , # Material (Sales)
        # "DISTR_CHAN"      , # Distribution Channel
        "CUSTOMER"        , # Customer number
        # "DIVISION"        , # Division
        # "CALYEAR"         , # Calendar year
        # "CALMONTH2"       , # Calendar month
        "CUST_HIE02"      , # Customer Hierarchy Level 2
        "CUST_HIE01"      , # Customer Hierarchy Level 1
        "/BIC/DEMND_QTY"  , # Demand qty
        # "/BIC/BSELN_QTY"  , # Baseline qty
        # "/BIC/PROMO_QTY"  , # Promotion qty
        # "/BIC/DMDCP_QTY"  , # Demand components qty
        # "/BIC/PRMCP_QTY"  , # Promo components qty
        "BASE_UOM"          # Base Unit of Measure
    ),
     pRowcount = Inf
   )

```


### SDSFRPR4 ✔

Dynasys post demand review forecast

```{r}
#| label:   'get_data_SDSFRPR4'
#| comment: 'post-DR Forecast ####'
#| eval:    true

# Active Data Table for DataStore SDSFRPR4 #### 
B4_SDSFRPR42_A <- 
   fRead_and_Union(
     pSIDCLNT  = "WPB500",
     pTable    = "/BIC/ASDSFRPR42",
     pOptions  = list(
       paste0("MATERIAL = '", MAT, "'"), "AND",
       "/BIC/VERSMON >= '202301'"
     ),
     pFields   = list(
        # "COMP_CODE"       , # Company code                 X
        # "SALESORG"        , # Sales Organization           X
        # "PLANT"           , # Plant                        X
        # "MATERIAL"        , # Material                     X
        # "CUST_HIE03"      , # Customer Hierarchy Level 3   X
        # "CALMONTH"        , # Calendar year/month          X
        # "VTYPE"           , # Value Type for Reporting     X
        # "/BIC/FTYPE"      , # Forecast Type                X
        # "/BIC/VERSMON"    , # Version Calendar year/month  X
        # "RECORDMODE"      , #                              
        # "UPD_DATE"        , # Update Date                  
        # "CUST_HIE02"      , # Customer Hierarchy Level 2   
        # "CUST_HIE01"      , # Customer Hierarchy Level 1   
        # "/BIC/DEMND_QTY"  , # Demand qty                   
        # "/BIC/BSELN_QTY"  , # Baseline qty                 
        # "/BIC/PROMO_QTY"  , # Promotion qty                
        # "/BIC/DMDCP_QTY"  , # Demand components qty        
        # "/BIC/PRMCP_QTY"  , # Promo components qty         
        # "BASE_UOM"          # Base Unit of Measure         
    ),
     pRowcount = Inf
   )

if(rstudioapi::showQuestion(
  title   = "Save?", 
  message = "Do you want to save the data?"
) == TRUE) {
  saveRDS(
    object = B4_SDSFRPR42_A, 
    file = file.path(PDAT, "B4_SDSFRPR42_A.rds")
  )
}
```

### SDMFRPR4 ❌

Dynasys post demand review forecast

Enriched with 

- MONTHDIFF
- Company Code from SalesOrg

```{r}
#| label:   'get_data_SDMFRPR42'
#| comment: 'post-DR Forecast'
#| eval:     false

# Active Data Table for DataStore SDMFRPR4 #### 
B4_SDMFRPR42_A <- 
   fRead_and_Union(
     pSIDCLNT  = "WPB500",
     pTable    = "/BIC/ASDMFRPR42",
     pOptions  = list(
       paste0("MATERIAL = '", MAT, "'"), "AND",
       "/BIC/VERSMON = '202501'"       , "AND",
       "SALESORG     = 'FR30'"           
     ),
     pFields   = list(
        "COMP_CODE"       , # Company code                  X
        "SALESORG"        , # Sales Organization            X
        "PLANT"           , # Plant                         X
        "MATERIAL"        , # Material                      X
        "CUST_HIE03"      , # Customer Hierarchy Level 3    X
        "CALMONTH"        , # Calendar year/month           X
        "/BIC/VERSMON"    , # Version Calendar year/month   X
        "VTYPE"           , # Value Type for Reporting      X
        "/BIC/FTYPE"      , # Forecast Type                 X
        # "RECORDMODE"      , #
        # "/BIC/MNTHDIFF"   , # Months Difference
        # "/BIC/VERSYEAR"   , # Version Year
        # "/BIC/VERSMON2"   , # Version month (2)
        # "FISCPER3"        , # Posting period
        # "FISCPER"         , # Fiscal year / period
        # "FISCVARNT"       , # Fiscal year variant
        # "FISCYEAR"        , # Fiscal year
        # "UPD_DATE"        , # Update Date
        # "CUST_SALES"      , # Customer number (sales view)
        # "MAT_PLANT"       , # Material Plant
        # "MAT_SALES"       , # Material (Sales)
        # "DISTR_CHAN"      , # Distribution Channel
        "CUSTOMER"        , # Customer number
        # "DIVISION"        , # Division
        # "CALYEAR"         , # Calendar year
        # "CALMONTH2"       , # Calendar month
        # "CALQUART1"       , # Quarter
        # "CALQUARTER"      , # Calendar year/quarter
        "CUST_HIE02"      , # Customer Hierarchy Level 2
        "CUST_HIE01"      , # Customer Hierarchy Level 1
        "/BIC/DEMND_QTY"  , # Demand qty
        "/BIC/BSELN_QTY"  , # Baseline qty
        "/BIC/PROMO_QTY"  , # Promotion qty
        # "/BIC/DMDCP_QTY"  , # Demand components qty
        # "/BIC/PRMCP_QTY"  , # Promo components qty
        "BASE_UOM"          # Base Unit of Measure
    ),
     pRowcount = Inf
   )

```

### OPSTARG

```{r}
#| label: 'get_data_OPSTARG',
#| eval:  true

# Active Data Table for DataStore OPSTARG #### 
B4_OPSTARG2_A <- 
   fRead_and_Union(
     pSIDCLNT  = "WPB500",
     pTable    = "/BIC/AOPSTARG2",
     pOptions  = list(),
     pFields   = list(
        # "COMP_CODE"       , # Company code                   X
        # "CALYEAR"         , # Calendar year                  X
        # "FISCYEAR"        , # Fiscal year                    X
        # "FISCVARNT"       , # Fiscal year variant            X
        # "RECORDMODE"      , # NA                               
        # "FISCPER"         , # Fiscal year / period           
        # "/BIC/FA_TARG"    , # Forecast accuracy Target (%)   
        # "/BIC/BIAS_TARG"  , # Forecast bias Target (%)       
        # "/BIC/CTP_TARG"   , # CTP Target (%)                 
        # "/BIC/CSL_TARG"   , # CSL Target (%)                 
        # "/BIC/CRT_TARG"   , # Credit Memo Target (%)         
        # "COMP_CODE"       , # NA                               X
        # "CALYEAR"         , # NA                               X
        # "FISCYEAR"        , # NA                               X
        # "FISCVARNT"       , # NA                               X
        # "RECORDMODE"      , # BW Delta Process: Record Mode  
        # "FISCPER"         , # NA                               
        # "/BIC/FA_TARG"    , # NA                               
        # "/BIC/BIAS_TARG"  , # NA                               
        # "/BIC/CTP_TARG"   , # NA                               
        # "/BIC/CSL_TARG"   , # NA                               
        # "/BIC/CRT_TARG"     # NA                               
    ),
     pRowcount = Inf
   )

```

### IMP03SM1 ❌

Material Stocks & Movements

```{r}
#| label:   'get_data_IMP03SM1'
#| comment: 'Material Stocks & Movements'
#| eval:    false

IMP03SM1 <- 
  fread(file = file.path(PDAT, "WPB", "IMP03SM1_F.csv"))

```


## Promotions

### Dynasys

```{r}
#| label: 'get_promo_data'
#| eval:  false

promo_path <- 
  file.path("c:","PW","OneDrive","ET","pythia","dat","PROMO")

CL2_HDR <- 
  fread(file.path(promo_path, "CL2_HEADER.csv")) %>%
  unique()

CL2_ITM <- 
  fread(file.path(promo_path, "CL2_LINE.csv")) %>%
  unique()

CL2 <- 
  CL2_HDR[CL2_ITM, on = .(Promo_Code)] %>%
  .[Material_Code == '10023']

CL3_HDR <- 
  fread(file.path(promo_path, "CL3_HEADER.csv")) %>%
  unique()

CL3_ITM <- 
  fread(file.path(promo_path, "CL3_LINE.csv"))  %>%
  unique()

CL3 <- 
  CL3_HDR[CL3_ITM, on = .(Promo_Code)] %>%
  .[Material_Code == '10023']

PR_GL_CL2_HDR <- 
  fread(file.path(promo_path, "PR_GLOBAL_CL2_HEADER.csv")) %>%
  unique()

PR_GL_CL2_ITM <- 
  fread(file.path(promo_path, "PR_GLOBAL_CL2_LINE.csv")) %>%
  unique()

PR_GL_CL2 <- 
  PR_GL_CL2_HDR[PR_GL_CL2_ITM, on = .(
    Source_Code, Promo_Code)] %>%
  .[Material_Code == '10023']

PR_GL_CL3_HDR <- 
  fread(file.path(promo_path, "PR_GLOBAL_CL3_HEADER.csv")) %>%
  unique()

PR_GL_CL3_ITM <- 
  fread(file.path(promo_path, "PR_GLOBAL_CL3_LINE.csv")) %>%
  unique()

PR_GL_CL3 <- 
  PR_GL_CL3_HDR[PR_GL_CL3_ITM, on = .(
    Source_Code, Promo_Code)] %>%
  .[Material_Code == '10023']
```

### PromoNat

```{r}
#| label:   'get_promo_data_PROMONAT'
#| eval:    true
#| comment: 'Extraction from PROMONAT from Corentine ####'

PROMONAT <-
  read.xlsx(
    xlsxFile = file.path(PDAT, "PROMO", "export_20241002_143603.xlsx"),
    sheet = "Feuil1",
    detectDates = TRUE
  )                                                        %>%
  setDT()

fOpenExcel <- 
  function(pFile) {
    system(paste0("start excel ", normalizePath(pFile)))
  }
```

# Material Master Data

## Material (B4)

```{r}
#| label:   'get_data_MATERIAL'
#| comment: '0MATERIAL MD'
#| eval:     false

# Master Data (Time-Ind.): Characteristic Material #### 
B4_MATERIAL_P <- 
   fRead_and_Union(
     pSIDCLNT  = "WPB500",
     pTable    = "/BI0/PMATERIAL",
     pOptions  = list(
       "MATL_TYPE in ('FERT', 'HAWA')"
     ),
     pFields   = list(
        "MATERIAL"        , # Material                                          X
        # "OBJVERS"         , # Object version                                    X
        # "CHANGED"         , # Change flag ( I inserted / D deleted )
        # "/BIC/PRODH1"     , # Brand responsibility type
        # "/BIC/PRODH2"     , # Brand
        # "/BIC/PRODH3"     , # Category
        # "/BIC/PRODH4"     , # Family
        # "APO_PROD"        , # Product
        # "BASE_UOM"        , # Base Unit of Measure
        # "BASIC_MATL"      , # Basic material (basic constituent of a material)
        # "COMPETITOR"      , # Competitors
        # "CONT_UNIT"       , # Content unit
        # "CREATEDON"       , # Date on which the record was created
        # "CRM_PROD"        , # Product
        # "DIVISION"        , # Division
        # "EANUPC"          , # European Article Numbers/Universal Product Code
        # "EXTMATLGRP"      , # External material group
        # "GROSS_CONT"      , # Gross contents
        # "GROSS_WT"        , # Gross weight
        # "HEIGHT"          , # Height
        # "IND_SECTOR"      , # Industry sector
        # "LENGHT"          , # Length
        # "LOC_CURRCY"      , # Local currency
        # "LOGSYS"          , # Source System
        # "MANUFACTOR"      , # Manufacturer
        # "MANU_MATNR"      , # Manufacturer Part Number
        # "MATL_CAT"        , # Material category
        "MATL_GROUP"      , # Material group
        "MATL_TYPE"       , # Material type
        # "MSA_USAGE"       , # Usage
        # "NET_CONT"        , # Net contents
        # "NET_WEIGHT"      , # Net weight of item
        # "PO_UNIT"         , # Order unit
        # "PROD_HIER"       , # Product hierarchy
        # "SIZE_DIM"        , # Size/dimension
        # "STD_DESCR"       , # Industry Standard Description (such as DIN)
        # "UNIT_DIM"        , # Unit of dimension for length/width/height
        # "UNIT_OF_WT"      , # Weight unit
        # "VENDOR"          , # Vendor
        # "VOLUME"          , # Volume
        # "VOLUMEUNIT"      , # Volume unit
        # "WIDTH"           , # Width
        # "/BIC/MG_L1"      , # Old Material group level 1
        # "/BIC/MG_L2"      , # Old Material group level 2
        # "/BIC/MG_L3"      , # Old Material group level 3
        # "/BIC/MIN_RSL"    , # Minimum remaining shelf life (PO)
        "/BIC/MSTAE"      , # X-plant status
        "/BIC/MSTAV"      , # X-distribution chain status
        # "/BIC/OLD_MATNR"  , # Old material number
        # "AF_COLOR"        , # AFS Elementary Field "Color"
        # "AF_FCOCO"        , # AFS Fabric Content Code
        # "AF_GENDER"       , # AFS Target Group
        # "AF_GRID"         , # AFS Grid
        # "AF_STYLE"        , # AFS Intersection
        # "BBP_PROD"        , # Product
        # "HC_AGENT1"       , # Active Ingredient 1 (Main Active Ingredient)
        # "HC_AGENT2"       , # Active Ingredient 2
        # "HC_AGENT3"       , # Active Ingredient 3
        # "HC_ANESIND"      , # Anesthetic Indicator
        # "HC_APPRTYP"      , # Approval Type
        # "HC_ATCCODE"      , # ATC Code
        # "HC_ATCMTYP"      , # Type of Med. Category for ATC Code
        # "HC_CATIND1"      , # Catalog 1 Indicator
        # "HC_CATIND2"      , # Catalog 2 Indicator
        # "HC_CATIND3"      , # Catalog 3 Indicator
        # "HC_HAZMIND"      , # Hazardous Substance Indicator
        # "HC_IMPMIND"      , # Import Material Indicator
        # "RPA_WGH1"        , # Material Group Hierarchy Level 1
        # "RPA_WGH2"        , # Material Group Hierarchy Level 2
        # "RPA_WGH3"        , # Material Group Hierarchy Level 3
        # "RPA_WGH4"        , # Material Group Hierarchy Level 4
        # "RTPLCST"         , # Planned Purchase Price
        # "RT_COLOR"        , # Color
        # "RT_CONFMAT"      , # Cross-Plant Configur. Material
        # "RT_FASHGRD"      , # Fashion Grade
        # "RT_MDRELST"      , # Master Data Release Status
        # "RT_PRBAND"       , # Price Band Category
        # "RT_PRRULE"       , # Procurement Rule
        # "RT_SEAROLL"      , # Collection
        # "RT_SEASON"       , # Season Category
        # "RT_SEASYR"       , # Season Year
        # "RT_SEAYR"        , # Season Year
        # "RT_SIZE"         , # Size
        # "RT_SUPS"         , # Source of Supply
        # "UCCERTIFTY"      , # Certification Type
        # "UCCONSTCLA"      , # Construction Class
        # "UCFUNCCLAS"      , # Function Class
        # "DF_DGNR"         , # Hazardous Material Number
        # "DF_PROFILE"      , # Profile for Dangerous Goods Indicator
        # "RF_SIZE2"        , # Size 2
        # "RF_BNDID"        , # Brand
        # "RF_FRECHAR"      , # General Analysis Characteristic
        # "RT_COLRNGE"      , # Color Characteristic range
        # "RT_SIZRNGE"      , # Size Characteristic range
        # "/BIC/MATLGRP71"  , # Categ. Mgr NL40 Natudis
        # "/BIC/MATLGRP72"  , # Categ. Mgr NL10 Foodprints
        # "/BIC/MATLGRP73"  , # Categ. Mgr GB10 Kallo
        # "/BIC/MATLGRP74"  , # Categ. Mgr FR30 Distriborg France
        # "/BIC/MATLGRP75"  , # Categ. Mgr FR40 Bonneterre
        # "/BIC/MATLGRP76"  , # Categ. Mgr BE10 Hagor
        # "/BIC/MATLGRP77"  , # Categ. Mgr DE20 Fachhandel
        # "/BIC/MATLGRP78"  , # Categ. Mgr DE30 CoSA Naturprodukte
        # "/BIC/MATLGRP79"  , # Categ. Mgr DE*
        # "/BIC/STRAT_BUY"  , # Family
        # "/BIC/EA_PAL"     , # Eaches per Pallet
        # "/BIC/SR_RSPO"    , # RSPO indicator
        # "/BIC/SR_SUST"    , # Sustainability Indicator
        # "/BIC/SR_FAIRTR"  , # Fair Trade
        # "/BIC/SR_NUTRI"   , # Nutritional
        # "/BIC/SR_ORG"     , # Organic
        # "/BIC/SR_VEGI"    , # Vegetarian
        "/BIC/PRDH1"      , # Name of the Brand
        "/BIC/PRDH2"      , # Main Category
        "/BIC/PRDH3"      , # Product Sub Category
        "/BIC/PRDH4"      , # Product Family
        "/BIC/BRANDTYP"   , # Marke
        "/BIC/BRANDNAME"  , # Full brand Name
        # "PLANT"           , # Plant
        "/BIC/LVORM"      , # DF at client level
        "DEL_FLAG"        #, # Deletion flag for all material data of a plant
        # "/BIC/M_GLTNFRE"  , # Gluten free
        # "/BIC/EA_CS"      , # Eaches per Case
        # "/BIC/MTPOS"      , # Item Category Group
        # "CH_ON"           , # Last changed on
        # "/BIC/MGL1"       , # Material group level 1
        # "/BIC/MGL2"       , # Material group level 2
        # "/BIC/MGL3"       , # Material group level 3
        # "/BIC/MGL4"       , # Material group level 4
        # "/BIC/CATTYP"     , # Category type
        # "/BIC/ZIS_SPEC"   , # Interspec Specification Number
        # "NT_WT_KG"        , # Net weight in kilograms
        # "GR_WT_KG"        , # Gross weight in kilograms
        # "/BIC/EA_LAY"     , # EA per Layer
        # "/BIC/TEMPCOND"   , # Temperature Conditions
        # "/BIC/TEMPC"      , # Temperature class
        # "CREATEDBY"         # Name of person who created the object
    ),
     pRowcount = Inf
   )
```


# Evaluation

## Forecast Accuracy

```{r}
#| label: 'replicate_SC113B'
#| eval:  true

dtFA <- 
  copy(B4_SDMFRCAC2_A)                                               %>%
  .[, .(
    ACT = sum(DEMND_QTY),
    FM1 = sum(DEMQTYM1)
  ), by = .(PLANT, MATERIAL, CALMONTH)
  ]                                                                  %>%
  .[, {
    E   = ACT - FM1
    E2  = E ^ 2
    AE  = abs(E)
    APE = 100 * (1 - AE / ACT)
    EPE = 100 * (1 - AE / FM1)
    .(PLANT, MATERIAL, CALMONTH, 
      ACT, FM1, E, E2, AE, APE, EPE)
  }
  ] %>%
  .[CALMONTH %between% c('202401', '202412')]                        %T>%
  setorder("PLANT", "MATERIAL", "CALMONTH")


# dtFA <- 
#   dtFA[
#     !is.nan(APE) & 
#     !is.nan(ECO) &   
#     !is.infinite(APE) &
#     !is.infinite(ECO) &  
#     APE > -100 &
#     ECO > -100  ]

FCST <- 
  copy(B4_SDSFRPR42_A)                                               %>%
  .[, STEP:= fdiff_mnths(VERSMON, CALMONTH)]                         %>%
  # .[, VERSMON:= NULL]                                              %>%
  #  .[]                                                             %>%
  .[, .(
    FCST = sum(DEMND_QTY)
  ), by = .(PLANT, MATERIAL, CALMONTH, STEP)
  ]                                                                  %T>%
  setorder("PLANT", "MATERIAL", "CALMONTH", "STEP")                  %>%
  .[
    STEP == 1 &
      CALMONTH %between% c('202401', '202412')]

ACTS <- 
  copy(B4_SDSFRPR12_A)                                               %>%
  .[, STEP:= fdiff_mnths(VERSMON, CALMONTH)]                         %>%  
  # .[, `:=`(VERSMON = NULL, UPD_DATE = NULL)]                       %>%
  # .[, STEP:= NA]                                                   %>%
  # .[, FTYPE    := 0]                                               %>%
  .[, .(
    ACTS = sum(DEMND_QTY)
  ), by = .(PLANT, MATERIAL, CALMONTH, STEP)
  ]                                                                  %T>%
  setorder("PLANT", "MATERIAL", "CALMONTH", "STEP")                  %>%  
  .[ 
    STEP == -1 &
      CALMONTH %between% c('202401', '202412') ]                     %>%
  .[ , `:=`(STEP = NULL)]                                         

# Full outer join
dtKEY <-
  rbind(
   ACTS[, .(PLANT, MATERIAL, CALMONTH)],
   FCST[, .(PLANT, MATERIAL, CALMONTH)]
  ) %>% unique()

CMB <-
  ACTS[dtKEY, on = .(PLANT, MATERIAL, CALMONTH)]                    %>%
  FCST[.    , on = .(PLANT, MATERIAL, CALMONTH)]                    

ACC <- 
  copy(CMB[])                                                        %>%
  .[, {
    E   = ACTS - FCST
    E2  = E ^ 2
    AE  = abs(E)
    APE = 100 * (1 - AE / ACTS)
    EPE = 100 * (1 - AE / FCST)
    .(PLANT, MATERIAL, CALMONTH, 
      ACT, FM1, E, E2, AE, APE, EPE)
  }
  ]

ggplot(ACTS, aes(x = CALMONTH, y = ACTS)) +
  geom_col(colour = "white", fill = ET_CG) +
  labs(
    x = "Month",
    y = "Quantity EA", 
    title = paste("Sales of SKU:", RL0(MAT), "per month")
    )                 +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```

```{r}
#| label:  'APE vs ECO'
#| eval:   true

ggplot(
  data = dtFA[
    CALMONTH >='202401' 
    & APE > -50
    # & MATERIAL == MAT
  ], 
  aes(x = APE, y = EPE)
) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  # geom_label(aes(label = round(PE, 1))) +
  # facet_wrap(~ PLANT + MATERIAL, scales = "free_y") +
  # scale_color_manual(values=c(ET_CG, ET_FG))+
  theme_minimal()
```

```{r}
#| label:  'SC-113B_1'
#| eval:   true

dtFA_melt  <- 
  copy(dtFA) %>%
  melt.data.table(
    measure.vars  = c("APE", "EPE"),
    variable.name = "PE_TYPE",
    value.name    = "PE"
    ) %T>% setorder(CALMONTH)

ggplot(
  data = dtFA_melt[CALMONTH >='202401' & MATERIAL == MAT], 
  aes(x     = CALMONTH, 
      y     = PE, 
      group = PE_TYPE, 
      color = PE_TYPE)
  ) +
  geom_line(linewidth = 2) +
  geom_point() +
  geom_label(aes(label = round(PE, 1))) +
  # facet_wrap(~ PLANT + MATERIAL, scales = "free_y") +
  scale_color_manual(values=c(ET_CG, ET_FG))+
  theme_minimal()

if(MAN){
  if(rstudioapi::showQuestion(
    title   = "SAC",
    message = "Do you want to open SC-113B?"
  ) == TRUE) {
    browseURL(url = "https://wessanen.eu10.sapanalytics.cloud/link/SC113B")
  }
}
```

# Modeling

```{r}

train_tr <- 
  train |>
  stretch_tsibble(.init = 24, .step = 1)

train_tr |>
  model(
    `Mean`           = MEAN(SLS_QT_SO)          ,
    `Naïve`          = NAIVE(SLS_QT_SO)         ,
    `Seasonal naïve` = SNAIVE(SLS_QT_SO)        ,
    `RW`             = RW(SLS_QT_SO ~ drift())  ,
    `ETS`            = ETS(SLS_QT_SO)           ,
    `Trend Model`    = TSLM(SLS_QT_SO ~ trend())
  ) |>
  forecast(h = 3) |>
  accuracy(train)
```

## CSV

```{r}
PKZ  <- "perkz_w"
OEXP <- file.path(FCT , "upg", "data")
PNW  <- file.path(OEXP, "WPB", "NEW")
PTRN <- file.path("C:", "PW", "OneDrive", "ET", "pythia", "dat", "WPB", "TRAN")

```


```{r}
#| label: 'RTP SALES', 
#| eval:  false

SLS_A <- fread(file = file.path(PYTH, "DD_HISTO_QTY.CSV"))

```

### 10023

```{r}
# Actuals from IMP or RTP

# SLS10023 <- 
#   fread(file = file.path(PYTH, "DD_HISTO_QTY.CSV"))                  %T>%
#   # fread(file.path(PNW , PKZ, "DEC", "DD_HISTO_QTY.CSV"))             %T>%
#   setnames(fGetOHFields("DSCP_TRAN"))                                %>%
#   .[MATERIAL == RL0(MAT)]                                            %>%
#   .[CALDAY   <  ymd("2024-10-01")]                                   %>%
#   .[PLANT    == "FR30"]                                              %>%
#   .[, `:=`(
#     CALMONTH = paste0(year(CALDAY), LP0(month(CALDAY)  , 2)),
#     CALWEEK  = paste0(year(CALDAY), LP0(isoweek(CALDAY), 2))
#   )]                                                                 %>%
#   CUST[, 
#        .(CUSTOMER, SALESORG,
#          CUSTHIE04, CUST_HIE03, CUST_HIE02, CUST_HIE01)][
#          ., on = .(CUSTOMER, SALESORG)]                              %>%
#   .[, SLS_QT:= SLS_QT_SO + SLS_QT_FOC]                               %>%
#   .[ , .(SLS_QT_SO = sum(SLS_QT) ), 
#      by = .(
#        MATERIAL,
#        # CUSTOMER,
#        # CUSTHIE04,
#        # CUST_HIE03,
#        # CUST_HIE02,
#        # CUST_HIE01,
#        PLANT,
#        # SALESORG,
#        # CALDAY,
#        CALMONTH #,
#        # CALWEEK
#      )] 
# 
# ggplot(SLS10023, aes(x = CALMONTH, y = SLS_QT_SO)) +
#   geom_col(colour = "white", fill = ET_CG) +
#   labs(
#     x = "Month",
#     y = "Quantity EA", 
#     title = paste("Sales of SKU:", RL0(MAT), "per month")
#     )                 +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1))

ts10023 <- 
  SLS10023[, CALMONTH:= yearmonth(CALMONTH, format = "%Y%m")] |> 
  as_tsibble(
    key   = c(MATERIAL, PLANT), 
    index = CALMONTH
    ) 

train <- 
  ts10023 |>
  filter(CALMONTH < yearmonth("202404", format("%Y%m"))) 

fit <- 
  train |> 
  model(
    `Mean`           = MEAN(SLS_QT_SO)          ,
    `Naïve`          = NAIVE(SLS_QT_SO)         ,
    `Seasonal naïve` = SNAIVE(SLS_QT_SO)        ,
    `RW`             = RW(SLS_QT_SO ~ drift())  ,
    `ETS`            = ETS(SLS_QT_SO)           ,
    `Trend Model`    = TSLM(SLS_QT_SO ~ trend())
  )

# fit |> gg_tsresiduals()

FCT10023 <- 
  fit |>
  forecast(h = "1 months") 

# FCT10023 |>
#   autoplot(ts10023, level = NULL) 

accuracy(FCT10023, ts10023)  
  
# SLS10023 %>%
#   dcast.data.table(
#     CALMONTH ~ CUST_HIE03,
#     value.var = "SLS_QT_SO",
#     fun.aggregate = sum
#   ) %T>% fOpen_as_xlsx()

PRM10023 <- 
  PROMONAT                                                 %>%
  .[Réf == RL0(MAT)]                                       %T>%
  fOpen_as_xlsx()
  # fwrite(file.path(PDAT, RL0(MAT), "PROMONAT.csv"))
```

## Create Workbook for Comparison

```{r add_to_list_for_sheet, eval=FALSE}
lst <- list()
lst <- c(lst, list("CL2"                    = CL2))
lst <- c(lst, list("CL3"                    = CL3))
lst <- c(lst, list("PR_GL_CL2"              = PR_GL_CL2))
lst <- c(lst, list("PR_GL_CL3"              = PR_GL_CL3))

```

```{r create_workbook_compare, eval=FALSE}
wb <- 
  createWorkbook(
    title    = wbt,
    subject  = "",
    category = wbc
  ) 

for (i in 1:length(lst)) {
  wsh <- lst[i] %>% names()
  dt  <- lst[[i]]
  addWorksheet(  wb = wb, sheet = wsh, gridLines = FALSE, tabColour = ET_CG)
  writeDataTable(wb = wb, sheet = wsh, x = dt, tableStyle = "TableStyleMedium4")
  freezePane(    wb = wb, sheet = wsh, firstActiveRow = 2, firstActiveCol = 2)
  setColWidths(  wb = wb, sheet = wsh, cols = 1:1000, widths = "auto")  
}

FN <- 
  "PROMO_10023" %>%
  paste0(format(Sys.time(), "%Y%m%d%H%M%S"), "-", ., ".xlsx")

FFN <- file.path(FCT, FN)

saveWorkbook(wb, file = FFN, overwrite = TRUE)
shell.exec(normalizePath(FFN))

```


