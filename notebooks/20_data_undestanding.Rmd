---
title   : EAISI - Pythia
subtitle: Data Understanding
author  : "F.J. Padt"
date    : "`r format(Sys.time(), '%B %d, %Y')`"
output  :
  pdf_document:
    df_print: paged
    toc: yes
    toc_depth: 1      
editor_options:
  chunk_output_type: console
  markdown: 
    wrap: 80  
---

\newpage

![Logo](C:/Users/floris.padt/OneDrive%20-%20Wessanen/Pictures/ECOTONE/Logo.png)

# References

## SAC

## Teams

-   

```{r Setup, eval=TRUE}

knitr::opts_chunk$set(
  cache   = FALSE,
  echo    = TRUE,     # include R source code in the output  
  eval    = TRUE,
  message = FALSE,
  warning = FALSE,
  results = "markup",
  image   = TRUE,  
  include = TRUE      # include the chunk output in the output 
)

# KnitR SetUp location
KS <- 
  file.path("C:", "RW", "ETRMK", "00_RProj", 
    "00_Global", "KnitR_SetUp.R")

library(reticulate)
use_condaenv("sapyr")

# public functions ---------------------------------------------------------
invisible(source(KS))
if( file.exists("functions.R")){source("functions.R")}

PDAT <- file.path("C:", "PW", "OneDrive", "ET", "pythia", "dat")

FLD <- file.path(IMM, "SLM")
wbt <- "" # workbook Title
wbc <- "" # workbook Category
wbf <- "" # workbook FileName

```

```{r}
#| label = 'set_globvar_and_functions',
#| eval  = true

SID <- "WPB500"
CCD <- "FR30" 
CYR <- 
MAT <- "10023" %>% LP0(18)
PLT <- "FR30"
VWK <-  ''

fdiff_mnths <- function(x, y) {
  strdate <- ymd(paste0(x, "01"))
  enddate <- ymd(paste0(y, "01"))
  interval(strdate, enddate) %/% months(1)
}
```

# Business reports

```{r}
#| label   = 'get_business_reports',
#| eval    = FALSE,
#| comment = "Open Sharepoint reports"  
  
shell.exec(normalizePath(file.path(OPS, "DOC", "EBI.xlsx")))
```

## Sharepoint

```{r}
#| label = 'get_sharepoint_reports',
#| eval  = FALSE

EBP <- 
  read.xlsx(
    xlsxFile = file.path(OPS, "DOC", "EBI.xlsx"),
    sheet = "EBP"
  )                                                                        %T>%
  setDT()                                                                  %>%
  .[, ENV:= "BIP"] 

EBQ <- 
  read.xlsx(
    xlsxFile = file.path(OPS, "DOC", "EBI.xlsx"),
    sheet = "EBQ"
  )                                                                        %T>%
  setDT()                                                                  %>%
  .[, ENV:= "BIQ"]

EBI <- rbind(EBP, EBQ, fill = TRUE)

fOpen_as_xlsx(
  EBI[Additional.Information == 'Forecast', .(
    Report.Code, Title, Content.Type, 
    Description, URL, Name,	Query,	ENV)
  ]
)  
```

# Data Import

## SDMFRCAC

```{r}
#| label = 'get_data_SDMFRCAC',
#| eval  = FALSE

# Active Data Table for DataStore SDMFRCAC #### 
B4_SDMFRCAC2_A <- 
   fRead_and_Union(
     pSIDCLNT  = "WPB500",
     pTable    = "/BIC/ASDMFRCAC2",
     pOptions  = list(
       paste0("MATERIAL = '", MAT, "'"), "AND",
       "/BIC/VERSMON >= '202306'"
     ),
     pFields   = list(
        "COMP_CODE"       , # Company code                  X
        "SALESORG"        , # Sales Organization            X
        "PLANT"           , # Plant                         X
        "MATERIAL"        , # Material                      X
        "CUST_HIE03"      , # Customer Hierarchy Level 3    X
        "CALMONTH"        , # Calendar year/month           X
        "/BIC/VERSMON"    , # Version Calendar year/month   X
        "/BIC/VTYPE"      , # Value Type for Reporting      X
        "/BIC/FTYPE"      , # Forecast Type                 X
        # "RECORDMODE"      , #
        # "/BIC/MNTHDIFF"   , # Months Difference
        # "CUST_SALES"      , # Customer number (sales view)
        # "MAT_PLANT"       , # Material Plant
        # "MAT_SALES"       , # Material (Sales)
        # "DISTR_CHAN"      , # Distribution Channel
        "CUSTOMER"        , # Customer number
        # "DIVISION"        , # Division
        # "CALYEAR"         , # Calendar year
        # "CALMONTH2"       , # Calendar month
        "CUST_HIE02"      , # Customer Hierarchy Level 2
        "CUST_HIE01"      , # Customer Hierarchy Level 1
        "BASE_UOM"        , # Base Unit of Measure
        "/BIC/DEMND_QTY"  , # Demand qty
        "/BIC/BSELN_QTY"  , # Baseline qty
        "/BIC/PROMO_QTY"  , # Promotion qty
        # "/BIC/DMDCP_QTY"  , # Demand components qty
        # "/BIC/PRMCP_QTY"  , # Promo components qty
        "/BIC/DEMQTYM0"   , # Demand qty ALL
        "/BIC/DEMQTYM1"   , # Demand qty M-1
        "/BIC/DEMQTYM2"   , # Demand qty M-2
        "/BIC/DEMQTYM3"   , # Demand qty M-3
        "/BIC/BSLNQTYM0"  , # Baseline qty ALL
        "/BIC/BSLNQTYM1"  , # Baseline qty M-1
        "/BIC/BSLNQTYM2"  , # Baseline qty M-2
        "/BIC/BSLNQTYM3"  , # Baseline qty M-3
        "/BIC/PRMQTYM0"   , # Promotion qty ALL
        "/BIC/PRMQTYM1"   , # Promotion qty M-1
        "/BIC/PRMQTYM2"   , # Promotion qty M-2
        "/BIC/PRMQTYM3"   #, # Promotion qty M-3
        # "/BIC/DMCPQTYM0"  , # Demand components qty ALL
        # "/BIC/DMCPQTYM1"  , # Demand components qty M-1
        # "/BIC/DMCPQTYM2"  , # Demand components qty M-2
        # "/BIC/DMCPQTYM3"  , # Demand components qty M-3
        # "/BIC/PRCPQTYM0"  , # Promo components qty ALL
        # "/BIC/PRCPQTYM1"  , # Promo components qty M-1
        # "/BIC/PRCPQTYM2"  , # Promo components qty M-2
        # "/BIC/PRCPQTYM3"    # Promo components qty M-3
    ),
     pRowcount = Inf
   ) 

```

## SDSFRPR1

```{r}
#| label   = 'get_data_SDSFRPR1',
#| comment = "pre-DR Forecast ####",
#| eval    = true

# Active Data Table for DataStore SDSFRPR1 #### 
B4_SDSFRPR12_A <- 
   fRead_and_Union(
     pSIDCLNT  = "WPB500",
     pTable    = "/BIC/ASDSFRPR12",
     pOptions  = list(
       paste0("MATERIAL = '", MAT, "'"), "AND",
       "/BIC/VERSMON >= '202306'"
     ),
     pFields   = list(
        "COMP_CODE"       , # Company code                 X
        "SALESORG"        , # Sales Organization           X
        "PLANT"           , # Plant                        X
        "MATERIAL"        , # Material                     X
        "CUST_HIE03"      , # Customer Hierarchy Level 3   X
        "CALMONTH"        , # Calendar year/month          X
        "VTYPE"           , # Value Type for Reporting     X
        # "/BIC/FTYPE"      , # Forecast Type                X
        "/BIC/VERSMON"    , # Version Calendar year/month  X
        # "RECORDMODE"      , #
        # "UPD_DATE"        , # Update Date
        "CUST_HIE02"      , # Customer Hierarchy Level 2
        "CUST_HIE01"      , # Customer Hierarchy Level 1
        "/BIC/DEMND_QTY"  , # Demand qty
        # "/BIC/BSELN_QTY"  , # Baseline qty
        # "/BIC/PROMO_QTY"  , # Promotion qty
        # "/BIC/DMDCP_QTY"  , # Demand components qty
        # "/BIC/PRMCP_QTY"  , # Promo components qty
        "BASE_UOM"          # Base Unit of Measure
    ),
     pRowcount = Inf
   )

```

## SDMFRPR1

```{r}
#| label   = 'get_data_SDMFRPR1', 
#| comment = "pre-DR Actuals ####",
#| eval    = TRUE

# Active Data Table for DataStore SDMFRPR1 #### 
B4_SDMFRPR12_A <- 
   fRead_and_Union(
     pSIDCLNT  = "WPB500",
     pTable    = "/BIC/ASDMFRPR12",
     pOptions  = list(
       paste0("MATERIAL = '", MAT, "'"), "AND",
       "/BIC/VERSMON >= '202306'"
     ),
     pFields   = list(
        "COMP_CODE"       , # Company code                  X
        "SALESORG"        , # Sales Organization            X
        "PLANT"           , # Plant                         X
        "MATERIAL"        , # Material                      X
        "CUST_HIE03"      , # Customer Hierarchy Level 3    X
        "CALMONTH"        , # Calendar year/month           X
        "/BIC/VERSMON"    , # Version Calendar year/month   X
        "VTYPE"           , # Value Type for Reporting      X
        # "/BIC/FTYPE"      , # Forecast Type                 X
        # "RECORDMODE"      , #
        "UPD_DATE"        , # Update Date
        # "CUST_SALES"      , # Customer number (sales view)
        # "MAT_PLANT"       , # Material Plant
        # "MAT_SALES"       , # Material (Sales)
        # "DISTR_CHAN"      , # Distribution Channel
        "CUSTOMER"        , # Customer number
        # "DIVISION"        , # Division
        # "CALYEAR"         , # Calendar year
        # "CALMONTH2"       , # Calendar month
        "CUST_HIE02"      , # Customer Hierarchy Level 2
        "CUST_HIE01"      , # Customer Hierarchy Level 1
        "/BIC/DEMND_QTY"  , # Demand qty
        # "/BIC/BSELN_QTY"  , # Baseline qty
        # "/BIC/PROMO_QTY"  , # Promotion qty
        # "/BIC/DMDCP_QTY"  , # Demand components qty
        # "/BIC/PRMCP_QTY"  , # Promo components qty
        "BASE_UOM"          # Base Unit of Measure
    ),
     pRowcount = Inf
   )

```

## SDMFRPR4

```{r}
#| label = 'get_data_SDMFRPR42',
#| comment = "post-DR Forecast ####",
#| eval = TRUE

# Active Data Table for DataStore SDMFRPR4 #### 
B4_SDMFRPR42_A <- 
   fRead_and_Union(
     pSIDCLNT  = "WPB500",
     pTable    = "/BIC/ASDMFRPR42",
     pOptions  = list(
       paste0("MATERIAL = '", MAT, "'"), "AND",
       "/BIC/VERSMON >= '202306'"
     ),
     pFields   = list(
        "COMP_CODE"       , # Company code                  X
        "SALESORG"        , # Sales Organization            X
        "PLANT"           , # Plant                         X
        "MATERIAL"        , # Material                      X
        "CUST_HIE03"      , # Customer Hierarchy Level 3    X
        "CALMONTH"        , # Calendar year/month           X
        "/BIC/VERSMON"    , # Version Calendar year/month   X
        "VTYPE"           , # Value Type for Reporting      X
        "/BIC/FTYPE"      , # Forecast Type                 X
        # "RECORDMODE"      , #
        # "/BIC/MNTHDIFF"   , # Months Difference
        # "/BIC/VERSYEAR"   , # Version Year
        # "/BIC/VERSMON2"   , # Version month (2)
        # "FISCPER3"        , # Posting period
        # "FISCPER"         , # Fiscal year / period
        # "FISCVARNT"       , # Fiscal year variant
        # "FISCYEAR"        , # Fiscal year
        # "UPD_DATE"        , # Update Date
        # "CUST_SALES"      , # Customer number (sales view)
        # "MAT_PLANT"       , # Material Plant
        # "MAT_SALES"       , # Material (Sales)
        # "DISTR_CHAN"      , # Distribution Channel
        "CUSTOMER"        , # Customer number
        # "DIVISION"        , # Division
        # "CALYEAR"         , # Calendar year
        # "CALMONTH2"       , # Calendar month
        # "CALQUART1"       , # Quarter
        # "CALQUARTER"      , # Calendar year/quarter
        "CUST_HIE02"      , # Customer Hierarchy Level 2
        "CUST_HIE01"      , # Customer Hierarchy Level 1
        "/BIC/DEMND_QTY"  , # Demand qty
        # "/BIC/BSELN_QTY"  , # Baseline qty
        # "/BIC/PROMO_QTY"  , # Promotion qty
        # "/BIC/DMDCP_QTY"  , # Demand components qty
        # "/BIC/PRMCP_QTY"  , # Promo components qty
        "BASE_UOM"          # Base Unit of Measure
    ),
     pRowcount = Inf
   )

```

## OPSTARG

```{r}
#| label = 'get_data_OPSTARG',
#| eval = TRUE


# Active Data Table for DataStore OPSTARG #### 
B4_OPSTARG2_A <- 
   fRead_and_Union(
     pSIDCLNT  = "WPB500",
     pTable    = "/BIC/AOPSTARG2",
     pOptions  = list(),
     pFields   = list(
        # "COMP_CODE"       , # Company code                   X
        # "CALYEAR"         , # Calendar year                  X
        # "FISCYEAR"        , # Fiscal year                    X
        # "FISCVARNT"       , # Fiscal year variant            X
        # "RECORDMODE"      , # NA                               
        # "FISCPER"         , # Fiscal year / period           
        # "/BIC/FA_TARG"    , # Forecast accuracy Target (%)   
        # "/BIC/BIAS_TARG"  , # Forecast bias Target (%)       
        # "/BIC/CTP_TARG"   , # CTP Target (%)                 
        # "/BIC/CSL_TARG"   , # CSL Target (%)                 
        # "/BIC/CRT_TARG"   , # Credit Memo Target (%)         
        # "COMP_CODE"       , # NA                               X
        # "CALYEAR"         , # NA                               X
        # "FISCYEAR"        , # NA                               X
        # "FISCVARNT"       , # NA                               X
        # "RECORDMODE"      , # BW Delta Process: Record Mode  
        # "FISCPER"         , # NA                               
        # "/BIC/FA_TARG"    , # NA                               
        # "/BIC/BIAS_TARG"  , # NA                               
        # "/BIC/CTP_TARG"   , # NA                               
        # "/BIC/CSL_TARG"   , # NA                               
        # "/BIC/CRT_TARG"     # NA                               
    ),
     pRowcount = Inf
   )

```

## SDWDMMG1

```{r}
#| label = 'get_data_SDWDMMG12',
#| eval = TRUE

# Active Data Table for DataStore SDWDMMG1 #### 
B4_SDWDMMG12_A <- 
   fRead_and_Union(
     pSIDCLNT  = "WPB500",
     pTable    = "/BIC/ASDWDMMG12",
     pOptions  = list(),
     pFields   = list(
        # "COMP_CODE"       , # Company code                                     X
        # "SALESORG"        , # Sales Organization                               X
        # "MATERIAL"        , # Material                                         X
        # "CALMONTH"        , # Calendar year/month                              X
        # "SALES_UNIT"      , # Sales unit                                       X
        # "BASE_UOM"        , # Base Unit of Measure                             X
        # "RECORDMODE"      , #                                                  
        # "DISTR_CHAN"      , # Distribution Channel                             
        # "PLANT"           , # Plant                                            
        # "/BIC/PRDH1"      , # Name of the Brand                                
        # "/BIC/PRDH2"      , # Main Category                                    
        # "/BIC/PRDH3"      , # Product Sub Category                             
        # "/BIC/PRDH4"      , # Product Family                                   
        # "/BIC/MAT_PROMO"  , # Promotional Material                             
        # "/BIC/PROMO_IDC"  , # Promotion Indicator                              
        # "DLV_QTY"         , # Actual quantity delivered (in sales units)       
        # "ACT_DL_QTY"      , # Actual quantity delivered in stockkeeping units  
        # "REQU_QTY"        , # Desired Delivery Quantity                        
        # "/BIC/FCQTYBU"    , # Forecast Qty BU                                  
        # "/BIC/FCQTYSU"    , # Forecast Qty SU                                  
        # "/BIC/F4QTYB"     , # Forecast Qty -4  (BUoM)                          
        # "/BIC/F4QTYS"     , # Forecast Qty -4  (SUoM)                          
        # "/BIC/FC8QTYB"    , # Forecast qty -8 BU                               
        # "/BIC/FC8_QTY"    , # Forecast qty -8 (SUoM)                           
        # "/BIC/FC13SUQTY"  , # Forecast Qty -13 SU                              
        # "/BIC/FC13_QTY"     # Forecast qty -13 (BUoM)                          
    ),
     pRowcount = Inf
   )

```

## SDMDMFR1

```{r}
#| label = 'get_data_SDMDMFR1',
#| comment = "",
#| eval = TRUE


# Active Data Table for DataStore SDMDMFR1 #### 
B4_SDMDMFR12_A <- 
   fRead_and_Union(
     pSIDCLNT  = "WPB500",
     pTable    = "/BIC/ASDMDMFR12",
     pOptions  = list(),
     pFields   = list(
        # "COMP_CODE"       , # Company code                                     X
        # "SALESORG"        , # Sales Organization                               X
        # "MATERIAL"        , # Material                                         X
        # "CALMONTH"        , # Calendar year/month                              X
        # "RECORDMODE"      , #                                                  
        # "PLANT"           , # Plant                                            
        # "SALES_UNIT"      , # Sales unit                                       
        # "BASE_UOM"        , # Base Unit of Measure                             
        # "MAT_PLANT"       , # Material Plant                                   
        # "CURRENCY"        , # Currency key                                     
        # "CALQUARTER"      , # Calendar year/quarter                            
        # "CALYEAR"         , # Calendar year                                    
        # "CALMONTH2"       , # Calendar month                                   
        # "/BIC/UOM_SEL2"   , # UoM Selection: 1 = BUoM | 2 = SUoM               
        # "/BIC/FCPER"      , # Forecast Period                                  
        # "/BIC/MEAS_SEL2"  , # Measure selection                                
        # "MAT_SALES"       , # Material (Sales)                                 
        # "DISTR_CHAN"      , # Distribution Channel                             
        # "DLV_QTY"         , # Actual quantity delivered (in sales units)       
        # "ACT_DL_QTY"      , # Actual quantity delivered in stockkeeping units  
        # "REQU_QTY"        , # Desired Delivery Quantity                        
        # "/BIC/FC8QTYB"    , # Forecast qty -8 BU                               
        # "/BIC/FC8_QTY"    , # Forecast qty -8 (SUoM)                           
        # "/BIC/FC13SUQTY"  , # Forecast Qty -13 SU                              
        # "/BIC/FC13_QTY"   , # Forecast qty -13 (BUoM)                          
        # "/BIC/FER8QTYB"   , # Forecast Error -8 BU                             
        # "/BIC/FERR8QTY"   , # Forecast Error -8 (SUoM)                         
        # "/BIC/FERR13QTY"  , # Forcast Error -13  (BUoM)                        
        # "/BIC/FER13QTYS"  , # Forecast Error -13 SU                            
        # "/BIC/ACTVAL"     , # Actuals amount                                   
        # "/BIC/FC8VAL"     , # Forecast -8 amount                               
        # "/BIC/FCER8VAL"   , # Forecast err -8 amount                           
        # "/BIC/FC13VAL"    , # Forecast -13 amount                              
        # "/BIC/FCER13VAL"  , # Forecast err -13 amount                          
        # "/BIC/F4QTYB"     , # Forecast Qty -4  (BUoM)                          
        # "/BIC/F4QTYS"     , # Forecast Qty -4  (SUoM)                          
        # "/BIC/F4VAL"      , # Forecast -4 amount                               
        # "/BIC/FER4QTYB"   , # Forecast Error -4  (BUoM)                        
        # "/BIC/FER4QTYS"   , # Forecast Error -4  (SUoM)                        
        # "/BIC/FER4VAL"    , # Forecast Error -4 amount                         
        # "/BIC/FCQTYBU"    , # Forecast Qty BU                                  
        # "/BIC/FCQTYSU"    , # Forecast Qty SU                                  
        # "/BIC/FERQTYB"    , # Forecast Error  (BUoM)                           
        # "/BIC/FERQTYS"    , # Forecast Error (SUoM)                            
        # "/BIC/FCVAL"      , # Forecast amount                                  
        # "/BIC/FERVAL"       # Forecast Error amount                            
    ),
     pRowcount = Inf
   )

```

## SDMDMFR2

```{r}
#| label = 'get_data_SDMDMFR2',
#| comment = "",
#| eval = TRUE

# Active Data Table for DataStore SDMDMFR2 #### 
B4_SDMDMFR22_A <- 
   fRead_and_Union(
     pSIDCLNT  = "WPB500",
     pTable    = "/BIC/ASDMDMFR22",
     pOptions  = list(),
     pFields   = list(
        # "COMP_CODE"       , # Company code                                     X
        # "SALESORG"        , # Sales Organization                               X
        # "MATERIAL"        , # Material                                         X
        # "CALMONTH"        , # Calendar year/month                              X
        # "/BIC/MAT_PROMO"  , # Promotional Material                             X
        # "RECORDMODE"      , #                                                  
        # "PLANT"           , # Plant                                            
        # "SALES_UNIT"      , # Sales unit                                       
        # "BASE_UOM"        , # Base Unit of Measure                             
        # "MAT_PLANT"       , # Material Plant                                   
        # "CURRENCY"        , # Currency key                                     
        # "CALQUARTER"      , # Calendar year/quarter                            
        # "CALYEAR"         , # Calendar year                                    
        # "CALMONTH2"       , # Calendar month                                   
        # "/BIC/PROMO_IDC"  , # Promotion Indicator                              
        # "/BIC/UOM_SEL2"   , # UoM Selection: 1 = BUoM | 2 = SUoM               
        # "/BIC/FCPER"      , # Forecast Period                                  
        # "/BIC/MEAS_SEL2"  , # Measure selection                                
        # "MAT_SALES"       , # Material (Sales)                                 
        # "DISTR_CHAN"      , # Distribution Channel                             
        # "/BIC/PRDH1"      , # Name of the Brand                                
        # "/BIC/PRDH2"      , # Main Category                                    
        # "/BIC/PRDH3"      , # Product Sub Category                             
        # "/BIC/PRDH4"      , # Product Family                                   
        # "DLV_QTY"         , # Actual quantity delivered (in sales units)       
        # "ACT_DL_QTY"      , # Actual quantity delivered in stockkeeping units  
        # "REQU_QTY"        , # Desired Delivery Quantity                        
        # "/BIC/FC8QTYB"    , # Forecast qty -8 BU                               
        # "/BIC/FC8_QTY"    , # Forecast qty -8 (SUoM)                           
        # "/BIC/FC13SUQTY"  , # Forecast Qty -13 SU                              
        # "/BIC/FC13_QTY"   , # Forecast qty -13 (BUoM)                          
        # "/BIC/FER8QTYB"   , # Forecast Error -8 BU                             
        # "/BIC/FERR8QTY"   , # Forecast Error -8 (SUoM)                         
        # "/BIC/FERR13QTY"  , # Forcast Error -13  (BUoM)                        
        # "/BIC/FER13QTYS"  , # Forecast Error -13 SU                            
        # "/BIC/ACTVAL"     , # Actuals amount                                   
        # "/BIC/FC8VAL"     , # Forecast -8 amount                               
        # "/BIC/FCER8VAL"   , # Forecast err -8 amount                           
        # "/BIC/FC13VAL"    , # Forecast -13 amount                              
        # "/BIC/FCER13VAL"  , # Forecast err -13 amount                          
        # "/BIC/F4QTYB"     , # Forecast Qty -4  (BUoM)                          
        # "/BIC/F4QTYS"     , # Forecast Qty -4  (SUoM)                          
        # "/BIC/F4VAL"      , # Forecast -4 amount                               
        # "/BIC/FER4QTYB"   , # Forecast Error -4  (BUoM)                        
        # "/BIC/FER4QTYS"   , # Forecast Error -4  (SUoM)                        
        # "/BIC/FER4VAL"    , # Forecast Error -4 amount                         
        # "/BIC/FCQTYBU"    , # Forecast Qty BU                                  
        # "/BIC/FCQTYSU"    , # Forecast Qty SU                                  
        # "/BIC/FERQTYB"    , # Forecast Error  (BUoM)                           
        # "/BIC/FERQTYS"    , # Forecast Error (SUoM)                            
        # "/BIC/FCVAL"      , # Forecast amount                                  
        # "/BIC/FERVAL"       # Forecast Error amount                            
    ),
     pRowcount = Inf
   )

```

## SDSFRPR3

```{r}
#| label   = 'get_data_SDSFRPR3',
#| comment = "",
#| eval    = TRUE

SDSFRPR3 <- 
  fread(file = file.path("C:\\PW\\OneDrive\\ET\\pythia\\dat\\SDSFRPR3.csv"))

```

## IMP03SM1

```{r}
#| label   = 'get_data_IMP03SM1',
#| comment = "",
#| eval    = TRUE

IMP03SM1 <- 
  fread(file = file.path(PDAT, "WPB", "IMP03SM1_F.csv"))

```

```{r}
#| label = 'compare_data',
#| eval = FALSE


SDMFRCAC <- 
  copy(B4_SDMFRCAC2_A)%>%
  .[, mnth_diff:= fdiff_mnths(VERSMON, CALMONTH)] %>%
  .[, .(
    SYSTID, CLIENT, COMP_CODE, SALESORG, PLANT, MATERIAL, CUST_HIE03,
    CALMONTH, VERSMON, VTYPE, FTYPE, CUSTOMER, CUST_HIE02, CUST_HIE01,
    BASE_UOM, DEMQTYM0,   
    BSELN_QTY = BSLNQTYM0, 
    PROMO_QTY = PRMQTYM0,
    mnth_diff 
  )]

SDMFRPR1 <- 
  copy(B4_SDMFRPR12_A)%>%
  .[, mnth_diff:= fdiff_mnths(VERSMON, CALMONTH)]

myNM <- names(SDMFRPR1)

SDMFRPR4 <- 
  copy(B4_SDMFRPR42_A)%>%
  .[, mnth_diff:= fdiff_mnths(VERSMON, CALMONTH)]



CMP <- 
  rbind(
    SDMFRCAC[VTYPE == '060', ..myNM][, TYP:="FRCAC"],
    SDMFRPR4[, TYP:="FRPR4"],
    use.names = TRUE
  ) %>%
  dcast(
    ... ~ TYP,
    fun.aggregate = length,
    value.var = "CLIENT"
  ) %>%
  .[, TOT:= FRPR4 + FRCAC]

View(CMP[TOT !=2 & CALMONTH >= '202309' & mnth_diff %in% 1:3])

# fOpen_as_xlsx(SDMFRPR1, "SDMFRPR1")
```

## PROMOTION

### Dynasys

```{r}
#| label = 'get_promo_data',
#| eval = FALSE

promo_path <- 
  file.path("c:","PW","OneDrive","ET","pythia","dat","PROMO")

CL2_HDR <- 
  fread(file.path(promo_path, "CL2_HEADER.csv")) %>%
  unique()

CL2_ITM <- 
  fread(file.path(promo_path, "CL2_LINE.csv")) %>%
  unique()

CL2 <- 
  CL2_HDR[CL2_ITM, on = .(Promo_Code)] %>%
  .[Material_Code == '10023']

CL3_HDR <- 
  fread(file.path(promo_path, "CL3_HEADER.csv")) %>%
  unique()

CL3_ITM <- 
  fread(file.path(promo_path, "CL3_LINE.csv"))  %>%
  unique()

CL3 <- 
  CL3_HDR[CL3_ITM, on = .(Promo_Code)] %>%
  .[Material_Code == '10023']

PR_GL_CL2_HDR <- 
  fread(file.path(promo_path, "PR_GLOBAL_CL2_HEADER.csv")) %>%
  unique()

PR_GL_CL2_ITM <- 
  fread(file.path(promo_path, "PR_GLOBAL_CL2_LINE.csv")) %>%
  unique()

PR_GL_CL2 <- 
  PR_GL_CL2_HDR[PR_GL_CL2_ITM, on = .(
    Source_Code, Promo_Code)] %>%
  .[Material_Code == '10023']

PR_GL_CL3_HDR <- 
  fread(file.path(promo_path, "PR_GLOBAL_CL3_HEADER.csv")) %>%
  unique()

PR_GL_CL3_ITM <- 
  fread(file.path(promo_path, "PR_GLOBAL_CL3_LINE.csv")) %>%
  unique()

PR_GL_CL3 <- 
  PR_GL_CL3_HDR[PR_GL_CL3_ITM, on = .(
    Source_Code, Promo_Code)] %>%
  .[Material_Code == '10023']
```

### PromoNat

```{r}
#| label = 'get_promo_data_PROMONAT',
#| eval = TRUE,
#| comment = "Extraction from PROMONAT from Corentine ####"

PROMONAT <-
  read.xlsx(
    xlsxFile = file.path(PDAT, "PROMO", "export_20241002_143603.xlsx"),
    sheet = "Feuil1",
    detectDates = TRUE
  )                                                        %>%
  setDT()

```

# Forecast Accuracy

```{r}

FCST <- 
  copy(B4_SDMFRPR42_A)                                               %>%
  .[, mnth_diff:= fdiff_mnths(VERSMON, CALMONTH)]                    %>%
  .[, VERSMON:= NULL]                                                %>%
  .[
    CALMONTH %between% c('202401', '202410') & 
      # CUSTOMER   == '0000030988' &
      # CUST_HIE01 == '0000030936' &
      # CUST_HIE03 == '0000030977' &
      TRUE
    ] 
 

ACTS <- 
  copy(B4_SDMFRPR12_A)                                               %>%
  .[, `:=`(VERSMON = NULL, UPD_DATE = NULL)]                         %>%
  .[, mnth_diff:= 0]                                                 %>%
  .[, FTYPE    := 0]                                                 %>%  
  .[
    CALMONTH %between% c('202401', '202410') & 
      # CUSTOMER   == '0000030988' &
      # CUST_HIE01 == '0000030936' &
      # CUST_HIE03 == '0000030977'
      TRUE
    ] 

CMB <- 
  rbind(ACTS, FCST, use.names = TRUE)                                %>%
  dcast(
    ... ~ "DQ" + paste0('V', VTYPE) + paste0('F', FTYPE) + 
      paste0('M', str_pad(mnth_diff, 2, "left", pad = "0")),
    fun.aggregate = sum,
    value.var = "DEMND_QTY"
  )                                                                  %>%
  melt.data.table(
    measure.vars  = patterns("V060"),
    variable.name = "FTYPE",
    value.name    = "FCST"
  ) 

ACC <- 
  copy(CMB[])                                                        %T>%
  setnames("V010_F0_M00", "ACTL")                                    %>%
  .[, .(ACTL = sum(ACTL), FCST = sum(FCST)), 
    by = .(
      SYSTID,
      CLIENT,
      COMP_CODE,
      SALESORG,
      PLANT,
      MATERIAL,
      CUST_HIE03,
      CALMONTH,
      # CUSTOMER,
      # CUST_HIE02,
      # CUST_HIE01,
      BASE_UOM,
      FTYPE
    )]                                                                %>%
  .[, `:=` (
    ERR = ACTL - FCST,
    AE  = abs(ACTL - FCST),
    APE = 100 * (1 - abs(ACTL - FCST) / ACTL),
    EPE = 100 * (1 - abs(ACTL - FCST) / FCST)
  )
  ]

# fwrite(
#   ACC[FTYPE == 'V060_F2_M00'], 
#   file.path(PDAT, RL0(MAT), "ACC.csv"), sep = ";")

```

```{r}

train_tr <- 
  train |>
  stretch_tsibble(.init = 24, .step = 1)

train_tr |>
  model(
    `Mean`           = MEAN(SLS_QT_SO)          ,
    `Naïve`          = NAIVE(SLS_QT_SO)         ,
    `Seasonal naïve` = SNAIVE(SLS_QT_SO)        ,
    `RW`             = RW(SLS_QT_SO ~ drift())  ,
    `ETS`            = ETS(SLS_QT_SO)           ,
    `Trend Model`    = TSLM(SLS_QT_SO ~ trend())
  ) |>
  forecast(h = 3) |>
  accuracy(train)
```


## CSV

```{r}
PKZ  <- "perkz_w"
OEXP <- file.path(FCT , "upg", "data")
PNW  <- file.path(OEXP, "WPB", "NEW")
PTRN <- file.path("C:", "PW", "OneDrive", "ET", "pythia", "dat", "WPB", "TRAN")

```


## Refresh Transaction Data

Note:decimal sep = , thousands sep = .

1. execute DTP: DTP_006EICO68TUM23UTWQUR6YBKL
2. download from AL11 to

```{r}
#| label = "write_destination_folder_in_clipboard",
#| eval = TRUE

clipr::write_clip("C:\\Users\\Floris.padt\\OneDrive - Wessanen\\Forecasting\\upg\\data\\WPB\\NEW\\perkz_w\\DD_HISTO_QTY.CSV")

# clipr::write_clip(file.path(PNW, PKZ, "DD_HISTO_QTY.CSV"))
```


```{r}
#| label = "Fixes During Upgrade", 
#| eval  = FALSE

fsubDOT <- 
  function(x){
    sub(pattern = "\\.", replacement = "", x = x)
  }

fsubCOM <- 
  function(x){
    sub(pattern = ",", replacement = ".", x = x)
  }

cols <- paste0("V", 6:12)    

fHST <- 
  function(PKZ){
    rbind(
      fread(file = file.path(PNW , PKZ, "DD_HISTO_QTY_ALL.CSV"))     %>%
        .[V5 < ymd("2024-01-01")],
      fread(file = file.path(PNW , PKZ, "DD_HISTO_QTY.CSV"))
    )                                                                %>%
      .[ , (cols) := lapply(.SD, FUN = fsubDOT), .SDcols = cols]     %>%
      .[ , (cols) := lapply(.SD, FUN = fsubCOM), .SDcols = cols]     %T>%
      fwrite(
        col.names = FALSE, 
        file      = file.path(PNW , PKZ, "DEC", "DD_HISTO_QTY.CSV"), 
        sep       = ";"
      )                                                              
  }

# system.time(fHST("perkz_t"))
system.time(fHST("perkz_w"))


```

```{r}
#| label = "get_data_filtered_by_mat",
#| eval = FALSE

# fGetData <- 
#   function(pPath, pSID, pFile) {
#     fread(
#       file.path(pPath, pSID, paste0(pFile, ".csv"))
#     )
#   }

# SALES <- 
#   fGetData(PDAT, "WPB", "SDMVSSL22")                               %>%
#   .[MATERIAL == MAT]                                               %>%
#   fwrite(file.path(PDAT, RL0(MAT), "SDMVSSL22.csv"), sep = ";")


CUST <- 
  fread(
    file = file.path(
      PNW , "perkz_w", "MD_SOLD_TO_CUSTOMER.CSV"
      )
    )                                                                %T>%
  setnames(fGetOHFields("DSCP_CUST"))                                

# SALES <- 
#   fread(file = file.path(PTRN, "DD_HISTO_QTY_ALL.csv"))              %>%
#   .[MATERIAL == RL0(MAT)]                                            %T>%
#   fwrite(file.path(PDAT, RL0(MAT), "DD_HISTO_QTY.csv"), sep = ";")
# 
# PROMONAT <-
#   read.xlsx(
#     xlsxFile = file.path(PDAT, "PROMO", "export_20241002_143603.xlsx"),
#     sheet = "Feuil1",
#     detectDates = TRUE
#   )                                                        %>% 
#   setDT()                                                  %>%
#   .[Réf == MAT]                                            %>% 
#   fwrite(file.path(PDAT, RL0(MAT), "PROMONAT.csv"))
#   
# STOCK <- 
#   fGetData(PDAT, "WPB", "IMP03SM1_F")                      %T>%
#   setnames(fGetOHFields("OH_STOCK"))                       %>%
#   .[MATERIAL == RL0(MAT)]                                  %>%
#   fwrite(file.path(PDAT, RL0(MAT), "IMP03SM1_F.csv"))
```


### 10023

```{r}

SLS10023 <- 
  fread(file.path(PNW , PKZ, "DEC", "DD_HISTO_QTY.CSV"))             %T>%
  setnames(fGetOHFields("DSCP_TRAN"))                                %>%
  .[MATERIAL == RL0(MAT)]                                            %>%
  .[CALDAY   <  ymd("2024-10-01")]                                   %>%
  .[PLANT    == "FR30"]                                              %>%
  .[, `:=`(
    CALMONTH = paste0(year(CALDAY), LP0(month(CALDAY)  , 2)),
    CALWEEK  = paste0(year(CALDAY), LP0(isoweek(CALDAY), 2))
  )]                                                                 %>%
  CUST[, 
       .(CUSTOMER, SALESORG,
         CUSTHIE04, CUST_HIE03, CUST_HIE02, CUST_HIE01)][
         ., on = .(CUSTOMER, SALESORG)]                              %>%
  .[, SLS_QT:= SLS_QT_SO + SLS_QT_FOC]                               %>%
  .[ , .(SLS_QT_SO = sum(SLS_QT) ), 
     by = .(
       MATERIAL,
       # CUSTOMER,
       # CUSTHIE04,
       # CUST_HIE03,
       # CUST_HIE02,
       # CUST_HIE01,
       PLANT,
       # SALESORG,
       # CALDAY,
       CALMONTH #,
       # CALWEEK
     )] 

ggplot(SLS10023, aes(x = CALMONTH, y = SLS_QT_SO)) +
  geom_col(colour = "white", fill = ET_CG) +
  labs(
    x = "Month",
    y = "Quantity EA", 
    title = paste("Sales of SKU:", RL0(MAT), "per month")
    )                 +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ts10023 <- 
  SLS10023[, CALMONTH:= yearmonth(CALMONTH, format = "%Y%m")] |> 
  as_tsibble(
    key   = c(MATERIAL, PLANT), 
    index = CALMONTH
    ) 

train <- 
  ts10023 |>
  filter(CALMONTH < yearmonth("202404", format("%Y%m"))) 

fit <- 
  train |> 
  model(
    `Mean`           = MEAN(SLS_QT_SO)          ,
    `Naïve`          = NAIVE(SLS_QT_SO)         ,
    `Seasonal naïve` = SNAIVE(SLS_QT_SO)        ,
    `RW`             = RW(SLS_QT_SO ~ drift())  ,
    `ETS`            = ETS(SLS_QT_SO)           ,
    `Trend Model`    = TSLM(SLS_QT_SO ~ trend())
  )

# fit |> gg_tsresiduals()

FCT10023 <- 
  fit |>
  forecast(h = "1 months") 

# FCT10023 |>
#   autoplot(ts10023, level = NULL) 

accuracy(FCT10023, ts10023)  
  
# SLS10023 %>%
#   dcast.data.table(
#     CALMONTH ~ CUST_HIE03,
#     value.var = "SLS_QT_SO",
#     fun.aggregate = sum
#   ) %T>% fOpen_as_xlsx()

ACTS %>%
    dcast.data.table(
    CALMONTH ~ CUST_HIE03,
    value.var = "DEMND_QTY",
    fun.aggregate = sum
  ) %T>% fOpen_as_xlsx()

PRM10023 <- 
  PROMONAT                                                 %>%
  .[Réf == RL0(MAT)]                                       %T>%
  fOpen_as_xlsx()
  # fwrite(file.path(PDAT, RL0(MAT), "PROMONAT.csv"))
```




## Create Workbook for Comparison

```{r add_to_list_for_sheet, eval=FALSE}
lst <- list()
lst <- c(lst, list("CL2"                    = CL2))
lst <- c(lst, list("CL3"                    = CL3))
lst <- c(lst, list("PR_GL_CL2"              = PR_GL_CL2))
lst <- c(lst, list("PR_GL_CL3"              = PR_GL_CL3))

```

```{r create_workbook_compare, eval=FALSE}
wb <- 
  createWorkbook(
    title    = wbt,
    subject  = "",
    category = wbc
  ) 

for (i in 1:length(lst)) {
  wsh <- lst[i] %>% names()
  dt  <- lst[[i]]
  addWorksheet(  wb = wb, sheet = wsh, gridLines = FALSE, tabColour = ET_CG)
  writeDataTable(wb = wb, sheet = wsh, x = dt, tableStyle = "TableStyleMedium4")
  freezePane(    wb = wb, sheet = wsh, firstActiveRow = 2, firstActiveCol = 2)
  setColWidths(  wb = wb, sheet = wsh, cols = 1:1000, widths = "auto")  
}

FN <- 
  "PROMO_10023" %>%
  paste0(format(Sys.time(), "%Y%m%d%H%M%S"), "-", ., ".xlsx")

FFN <- file.path(FCT, FN)

saveWorkbook(wb, file = FFN, overwrite = TRUE)
shell.exec(normalizePath(FFN))

```

```{r}
#| label = 'get_data_SDSFRCT0',
#| eval = TRUE

# Active Data Table for DataStore SDSFRCT0 #### 
B4_SDSFRCT02_A <- 
   fRead_and_Union(
     pSIDCLNT  = "WPB500",
     pTable    = "/BIC/ASDSFRCT02",
     pOptions  = list(
       paste0("MATERIAL = '", MAT, "'")
     ),
     pFields   = list(
        "PLANT"          , # Plant                          X
        "MATERIAL"       , # Material                       X
        "CALDAY"         , # Calendar day                   X
        "/BIC/VERSDATE"  , # Version date                   X
        # "RECORDMODE"     , # NA
        "CALWEEK"        , # Calendar year / week
        "/BIC/VERSWEEK"  , # Version week
        # "MAT_PLANT"      , # Material Plant
        "/BIC/KOPRW"     , # Corrected value forecast
        # "/BIC/PRWRT"     , # Forecast value (Qty)
        "BASE_UOM"       , # Base Unit of Measure
        "/BIC/PERKZ"       # Period Indicator
    ),
     pRowcount = Inf
   ) 

```

```{r}
#| label = 'get_data_SDSFRCT1',
#| eval = TRUE

SDSFRCT02 <- 
  copy(B4_SDSFRCT02_A)                         %>%
  .[CALWEEK %between% c('202401', '202452')]   %>%
  .[VERSDATE >= ymd("2023/09/04")]

```

# Material Master Data
```{r MATERIALS, eval = FALSE}
MARA <-
  fRead_and_Union(
    pSIDCLNT = WPE,
    pTable   = "MARA"   ,
    # pOptions = list("MTART IN ('HAWA', 'FERT', 'VOLL')"),
    pFields  = list(
      "MATNR", # Material Number
      "LVORM", # Flag Material for Deletion at Client Level
      "MTART", # Material type
      "MEINS", # Base Unit of Measure
      "PRDHA", # Product hierarchy
      "MHDRZ", # Minimum Remaining Shelf Life
      "MHDHB", # Total shelf life
      "MSTAE"  # Cross-Plant Material Status
    ),
    pRowcount = Inf
  )

MAKT <-
  fRead_and_Union(
    pSIDCLNT = WPE,
    pTable   = "MAKT"   ,
    pOptions = list("SPRAS = 'E'"),
    pFields  = list(
      "MATNR", #	Material Number
      "MAKTX"  #	Material Description
    ),
    pRowcount = Inf
  )

MARA <- 
  MAKT[MARA, on = .(SYSTID, CLIENT, MATNR)]
```

```{r info_records_and_vendor}
#| label = 'import_sap_data',
#| eval = TRUE



```



```{r Communicate, eval=TRUE}

wb <- 
  createWorkbook(
    title    = wbt,
    subject  = "",
    category = wbc
  ) 

for (i in 1:length(lst)) {
  wsh <- lst[i] %>% names()
  dt  <- lst[[i]]
  addWorksheet(  wb = wb, sheet = wsh, gridLines = FALSE, tabColour = ET_CG)
  writeDataTable(wb = wb, sheet = wsh, x = dt, tableStyle = "TableStyleMedium4")
  freezePane(    wb = wb, sheet = wsh, firstActiveRow = 2, firstActiveCol = 2)
  setColWidths(  wb = wb, sheet = wsh, cols = 1:1000, widths = "auto")  
}

FN <- 
  wbf %>%
  paste0(format(Sys.time(), "%Y%m%d%H%M%S"), "-", ., ".xlsx")

FFN <- file.path(FLD, FN)

saveWorkbook(wb, file = FFN, overwrite = TRUE)
shell.exec(normalizePath(FFN))

```
